# 第5章 网络层：控制平面

## 5.1 概述

- 每路由器控制
- 逻辑集中式控制

## 5.2 路由选择算法

> 路由选择算法的目的是：从发送方到接收方的过程中确定一条通过路由器网络的好的路径（通常好的路径是指最低开销的路径）

##### 最低开销路径

​	源和目的地之间具有最低开销的一条路

##### 最短路径

​	当所有的边具有相同开销时，最低开销路径也就是最短路径

### 路由选择算法分类

#### 根据集中式还是非集中式分类

##### 集中式路由选择算法

​	用完整的 、 全局性的网络知识计算岀从源到目的地之间的最低开销路径。要求在开始计算以前，能够获得所有节点之间的连通性以及所有链路的开销。具有全局状态信息的算法通常被称为链路状态(Link State，LS)算法、

##### 分散式路由选择算法

​	路由器以迭代 、 分布式的方式计算出最低开销路径。每个节点仅有与其直接相连链路的开销知识即可开始工作 。 然后 ， 通过迭代计算过程以及与相邻节点的信息交换 ， 一个节点逐渐计算出到达某目的节点或一组目的节点的最低开销路径 。后边会学习到DV算法，被称为距离向量算法的分散式路由选择算法。

#### 根据静态还是动态分类

##### 静态路由选择算法

​	路由随时间的变化非常缓慢，通常是人工进行调整

##### 动态路由选择算法

​	随着网络流量负载活拓扑发生变化而改变路由选择路径

#### 根据负载敏感还是迟钝分类

##### 负载敏感算法

​	链路开销会动态地变化以反映出底层链路的当前拥塞水平

##### 负载迟钝算法

​	当今因特网的路由选择算法都是负载迟钝的，因为某条链路的开销不明确地反映当前的拥塞水平

### 链路状态路由选择算法

​	Link-State BroadCast  链路状态广播算法 - Dijkstra算法

> 经过算法的第 k 次迭代后，可以知道到 k 个目的节点的最低开销路径，在到所有目的节点的最低开销路径之中，这 k 条路径具有 k 个最低开销。

##### 举例

考虑图 5-3 中的网络 ， 计算从 u 到所有可能目的地的最低开销路径 。 该算法的计算过程以表格方式总结于表 5-1 中 ， 表中的每一行给岀了迭代结束时该算法的变量的值。

<img src="https://happychan.oss-cn-shenzhen.aliyuncs.com/img/image-20210603163212686.png" alt="image-20210603163212686" style="zoom: 67%;" />

<img src="https://happychan.oss-cn-shenzhen.aliyuncs.com/img/image-20210603163136474.png" alt="image-20210603163136474" style="zoom:50%;" />

当 LS 算法终止时 ， 对于每个节点 ， 我们都得到从源节点沿着它的最低开销路径的前一节点 。 对于每个前一节点 ， 我们又有它的前一节点 ， 以此方式我们可以构建从源节点到所有目的节点的完整路径 。 通过对每个目的节点存放从 u 到目的地的最低开销路径上的下一跳节点 ， 在一个节点 （ 如节点 “ ） 中的转发表则能够根据此信息而构建 。

<img src="https://happychan.oss-cn-shenzhen.aliyuncs.com/img/image-20210603163324252.png" alt="image-20210603163324252" style="zoom:50%;" />

##### 问题

​	LS 算法可能会造成拥塞敏感的路由选择的震荡

<img src="https://happychan.oss-cn-shenzhen.aliyuncs.com/img/image-20210603163412653.png" alt="image-20210603163412653" style="zoom: 50%;" />

### 距离向量路由选择算法

Distance - Vector，DV 算法是一种迭代的、异步的和分布式的算法，而 LS 是一种使用全局信息的算法。

- 分布式：每个结点都要从一个或多个直接相邻邻居接受某些信息，执行计算，发送给邻居
- 迭代的：此过程要持续到邻居之间无更多信息要交换为止
- 异步的：不要求所有节点相互之间步伐一致地操作

具体查找步骤，请看书 P254-252

##### 问题

- 链路开销改变与链路故障
    - 某条链路开销突然减小，不会造成什么问题
    - 某条链路开销突然增大或者故障（无穷大），会造成路由选择环路，出现无穷计数的问题
- 如何避免 -> 增加毒性逆转【任然不能解决无穷计算问题】
    -  如果 z 通过 y 路由选择到目的地 x ， 则 z 将通告 y, 它（ 即 z ） 到 x 的距离是无穷大 ， 也就是 z 将向 y 通告 Dz（ x ） =oo （ 即使 z 实际上知道Dz（ x ）=5 ）。只要 z 经 y 路由选择到 x ， z 就持续地向 y 讲述这个善意的小谎言 。 因为 y 相信 z 没有到 x 的路径 ， 故只要 z 继续经 y 路由选择到 x （ 并这样去撒谎 ） ， y 将永远不会试图经由 z路由选择到 x 

##### 改进

​	LS 与 DV 路由选择算法的比较，DV 和 LS 算法采用互补的方法来解决路由选择计算的问题。

## 5.3 OSPF

问题的抛出

1. 规模。随着路由器数量变得很大，涉及路由选择信息的通信、计算和存储的开销将高的不可实现。必须采取一些措施以减少计算的复杂性。
2. 管理自治。因特网是ISP的网络，每个ISP都有它自己的路由器网络，它们想要对外部隐藏其网络的内部组织面貌，还要能够与其他外部网络连接起来。

这两个问题可以通过将路由器组织进自治系统（Autonomous System，AS）来解决。

> 每个AS可由一组处在相同管理控制下的路由器组成，通常一个ISP的路由器以及互联它们的链路构成一个AS。某些ISP 会划分为多个 AS。某一级的 ISP 在其整个网络中使用一个庞大的 AS，而其他的 ISP 则将它们的 ISP 拆分为数十个互联的 AS。每个 AS 都有一个全局唯一的 AS号，由 ICANN区域注册机构分配。

在相同的 AS 中的路由器都运行着相同的路由选择算法并且有彼此的信息。一个自治系统内运行的路由选择算法叫做自治系统内部路由选择协议。

### 开放最短路优先 OSPF

​	OSPF 是一种链路状态协议 ， 它使用洪泛链路状态信息和 Dijkstra 最低开销路径算法 。使用 OSPF, — 台路由器构建了一幅关于整个自治系统的完整拓扑图 （ 即一幅图 ）。于是，每台路由器在本地运行 Dijkstra 的最短路径算法 ， 以确定一个以自身为根节点到所有子网的最短路径树 。

使用 OSPF 时 ， 路由器向自治系统内所有其他路由器广播路由选择信息 ， 而不仅仅是向其相邻路由器广播 。 每当一条链路的状态发生变化时 （ 如开销的变化或连接 / 中断状态的变化 ），路由器就会广播链路状态信息 。 即使链路状态未发生变化 ， 它也要周期性地（ 至少每隔 30 min - 次 ） 广播链路状态。

OSPF 通告包含在 OSPF 报文中 ， 该 OSPF报文直接由 IP 承载 ， 对 OSPF 其上层协议的值为 89 。 因此 OSPF 协议必须自己实现诸如可靠报文传输 、 链路状态广播等功能 。

#### 优点

- 安全
- 多条相同开销的路径
- 对单播与多播路由选择的综合支持
- 支持在单个 AS 中的层次结构



## 5.4 ISP 之间的路由选择：BGP

​	Broder GateWay Protocol，BGP。所有的 AS 运行相同的 AS 间路由选择协议，称为边界网关协议，BGP

### BGP 的作用

OSPF负责 AS 内部的路由转发，而 BGP 则负责对位于 AS 外部的目的地的转发协议

- 从邻居 AS 获得前缀的可达性信息
- 确定到该前缀的“最好的”路由

### 通告 BGP 路由信息

- 网关路由器：一台位于 AS 边缘的路由器，它直接连接到在其他 AS 中的一台或多态路由器
- 内部路由器：仅连接在它自己 AS 中的主机和路由器

##### BGP 连接

​	在 BGP ，每对路由器通过使用端口 179 的半永久 TCP 连接来交换路由选择信息。每条直接连接以及所有通过该连接发送的 BGP 报文，都称为 BGP 连接

- 外部 BGP 连接：跨越两个 AS 的BGP连接
- 内部BGP 连接：在相同 AS 中的两台路由器之间的 BGP 会话

AS 之间用 eBGP 连接，AS 内部用 iBGP 连接

<img src="https://happychan.oss-cn-shenzhen.aliyuncs.com/img/image-20210604194432433.png" alt="image-20210604194432433" style="zoom:50%;" />

### 确定最好的路由

​	从一个给定的路由到一个目的子网可能有多条路径，如何确定一个最好的路径呢？

- AS-PATH属性：包含通告已经通过的 AS 的列表， 当一个前缀通过某 AS 时 ， 该 AS 将其 ASN 加入 AS-PATH 中的现有列表 。 例如 ， 在图5-10 中 ， 从 AS1 到子网 x 有两条路 ： 其中一条使用 AS-PATH “ AS2 AS3 ” ； 而另一条使用AS-PATH “ AS3 ” 。 BGP 路由器还使用 AS-PATH 属性来检测和防止通告环路 ； 特别是 ， 如果一台路由器在路径列表中看到包含了它自己的 AS, 它将拒绝该通告

- NEXT-HOP：记录 AS-PATH 起始的路由器接口的 IP 地址

#### 热土豆路由选择

使用热土豆路由选择 ，（ 从所有可能的路由中 ） 选择的路由到开始该路由的 NEXT-HOP 路由器具有最小开销。 对于路由器 1b, 尽可能快地将分组送出其 AS （ 更明确地说 ， 用可能的最低开销 ） ， 而不担心其 AS 外部到目的地的余下部分的开销 。 

分组被类比为烫手的热土豆 。 因为它烫手 ， 你要尽可能快地将它传给另一个人 （ 另一个 AS ） 。 热土豆路由选择因而是自私的算法 ， 即它试图减小在它自己 AS 中的开销 ， 而忽略在其 AS 之外的端到端开销的其他部分 。 

<img src="https://happychan.oss-cn-shenzhen.aliyuncs.com/img/image-20210604195029543.png" alt="image-20210604195029543" style="zoom:50%;" />

#### 路由器选择算法

对于任何给定的目的地前缀 ， 进入 BGP 的路由选择算法的输入是到某前缀的所有路由的集合 ， 该前缀是已被路由器学习和接受的 。 如果仅有一条这样的路由 ， BGP 则显然选择该路由 。 如果到相同的前缀有两条或多条路由 ， 则顺序地调用下列消除规则直到余下一条路由：

- 本地偏好值，具有最高本地偏好值的路由器将被选择。这个值是由 AS 的网络管理员设置的
- 对于具有相同的最高本地偏好值的路由集合，选择具有最短 AS-PATH 的路由

- 对于具有相同的最高本地偏好值和相同的 AS-PATH 长度的路由集合，使用热土豆选择，选择最靠近 NEXT-HOP 路由器的路由
- 如果还有剩余，则使用 BGP 标识符来选择路由

### IP 任播

​	BGP 还常被用于实现 IP 任播服务，该服务通常位于 DNS 中。

考虑以下场景：

1. 在许多分散的不同地理位置 ， 替换不同服务器上的相同内容 ； 
2. 让每个用户从最靠近的服务器访问内容 。 

例如 ， 一个 CDN 能够更换位于不同国家 、不同服务器上的视频和其他对象 。 类似地 ， DNS 系统能够在遍及全世界的DNS 服务器上复制 DNS 记录 。 当一个用户要访问该复制的内容 ， 可以将用户指向具有该复制内容的 “ 最近的 ” 服务器 。 BGP 的路由选择算法为做这件事提供了一种最为容易和自然的机制

<img src="https://happychan.oss-cn-shenzhen.aliyuncs.com/img/image-20210604201013936.png" alt="image-20210604201013936" style="zoom:50%;" />

如图 5 -12 所示 ， 在 IP任播配置阶段 ， CDN 公司为它的多台服务器指派相同的 IP 地址 ， 并且使用标准的 BGP 从这些服务器的每台来通告该 IP 地址 。 当某台 BGP 路由器收到对于该 IP 地址的多个路由通告 ， 它将这些通告处理为对相同的物理位置提供不同的路径 （ 事实上 ， 这时这些通告对不同的物理位置是有不同路径的 ）。

当配置其路由选择表时 ， 每台路由器将本地化地使用BGP 路由选择算法来挑选到该 IP 地址的 “ 最好的 ” （ 例如 ， 由 AS 跳计数确定的最近的 ）路由 。 例如 ， 如果一个 BGP 路由 （ 对应于一个位置 ） 离该路由器仅一 AS 跳的距离 ， 并且所有其他 BGP 路由 （ 对应于其他位置 ） 是两 AS 跳和更多 AS 跳 ， 则该 BGP 路由器将选择把分组路由到一跳远的那个位置 。

尽管上述 CDN 的例子很好地诠释了能够如何使用 IP 任播 ， 但实践中 CDN 通常选择不使用 IP 任播 ， 因为 BGP 路由选择变化能够导致相同的 TCP 连接的不同分组到达 Web 服务器的不同实例 。 但 IP 任播被 DNS 系统广泛用于将 DNS 请求指向最近的根 DNS 服务器 

### 路由选择策略

​	不知道怎么描述嘿嘿

## 5.5 SDN 控制平面

Software Defined Network，SDN体系结构的四个关键特征：

1. 基于流的转发
2. 数据平面与控制平面分离
3. 网络控制功能
4. 可编程的网络

## 5.6 ICMP

因特网控制报文协议，ICMP，被主机和路由器用来彼此沟通网络层的信息

-  ICMP 最典型的用途是差错报告 
- ICMP 通常被认为是 IP 的一部分
- ICMP 报文有一个类型字段和一个编码字段 ， 并且包含引起该 ICMP 报文首次生成的 IP 数据报的首部和前 8 个字节 （ 以便发送方能确定引发该差错的数据报 ） 

<img src="https://happychan.oss-cn-shenzhen.aliyuncs.com/img/image-20210604205255586.png" alt="image-20210604205255586" style="zoom:50%;" />

## 5.7 网络管理和 SNMP



## 5.8 小结

控制平面是网络范围的逻辑，不仅控制从源主机到目的主机沿着端到端的路径在路由器之间如何转发数据报，而且控制网络层组件和服务器如何配置与管理

两大类控制平面方法

- 传统的路由器控制： 其在每台路由器中运行算法 ， 并且路由器中的路由选择组件与其他路由器中的路由选择组件通信
- 软件定义网络控制 SDN：其中一个逻辑上集中的控制器计算并向每台路由器分发转发表为它们所用

两种基本的路由选择算法

- 链路状态 LS
- 距离矢量 DV

路由选择协议

- OSPF
- BGP

网络控制平面的 SDN 方法

- 网络控制应用程序
- SDN 控制器
- 控制器 和 SDN 控制设备之间通信使用的 OpenFlow 协议

网络管理

- ICMP
- SNMP



## 

## 



























































