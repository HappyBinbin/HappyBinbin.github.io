## 前言

股票问题一共有六道题，链接如下：

121. 买卖股票的最佳时机
122. 买卖股票的最佳时机 II
123. 买卖股票的最佳时机 III
188. 买卖股票的最佳时机 IV
309. 最佳买卖股票时机含冷冻期
126. 买卖股票的最佳时机含手续费

每个问题都有优质的题解，但是大多数题解没有建立起这些问题之间的联系，也没有给出股票问题系列的通解。这篇文章给出适用于全部股票问题的通解，以及对于每个特定问题的特解。

## 通用情况

这个想法基于如下问题：给定一个表示每天股票价格的数组，什么因素决定了可以获得的最大收益？

相信大多数人可以很快给出答案，例如「在哪些天进行交易以及允许多少次交易」。这些因素当然重要，在问题描述中也有这些因素。然而还有一个隐藏但是关键的因素决定了最大收益，下文将阐述这一点。

首先介绍一些符号：

- 用 `n` 表示股票价格数组的长度；
- 用 `i` 表示第 `i` 天（`i` 的取值范围是 `0` 到 `n - 1`）；
- 用 `k` 表示允许的最大交易次数；
- 用 `T[i][k]` 表示在第 `i` 天结束时，**最多**进行 `k` 次交易的情况下可以获得的最大收益。

基准情况是显而易见的：`T[-1][k] = T[i][0] = 0`，表示没有进行股票交易时没有收益（注意第一天对应 `i = 0`，因此 `i = -1` 表示没有股票交易）。现在如果可以将 `T[i][k]` 关联到子问题，例如 `T[i - 1][k]`、`T[i][k - 1]`、`T[i - 1][k - 1]` 等子问题，就能得到状态转移方程，并对这个问题求解。如何得到状态转移方程呢？

最直接的办法是看第 i 天可能的操作。有多少个选项？答案是三个：**买入、卖出、休息。**应该选择哪个操作？答案是：并不知道哪个操作是最好的，但是可以通过计算得到选择每个操作可以得到的最大收益。假设没有别的限制条件，则可以尝试每一种操作，并选择可以最大化收益的一种操作。但是，题目中确实有限制条件，规定不能同时进行多次交易，因此如果决定在第 i 天**买入**，在买入之前必须持有 0 份股票，如果决定在第 i 天**卖出**，在卖出之前必须恰好持有 1 份股票。持有股票的数量是上文提及到的隐藏因素，该因素影响第 i 天可以进行的操作，进而影响最大收益。

因此对 `T[i][k]` 的定义需要分成两项：

- `T[i][k][0]` 表示在第 `i` 天结束时，**最多**进行 `k` 次交易且在进行操作后持有 `0` 份股票的情况下可以获得的最大收益；

- `T[i][k][1]` 表示在第 `i` 天结束时，**最多**进行 `k` 次交易且在进行操作后持有 `1` 份股票的情况下可以获得的最大收益。

使用新的状态表示之后，可以得到基准情况和状态转移方程。

基准情况：

```java
T[-1][k][0] = 0, T[-1][k][1] = -Infinity
T[i][0][0] = 0, T[i][0][1] = -Infinity
```

状态转移方程：

```java
T[i][k][0] = max(T[i - 1][k][0], T[i - 1][k][1] + prices[i])
T[i][k][1] = max(T[i - 1][k][1], T[i - 1][k - 1][0] - prices[i])
```

基准情况中，`T[-1][k][0] = T[i][0][0] = 0` 的含义和上文相同，`T[-1][k][1] = T[i][0][1] = -Infinity` 的含义是在没有进行股票交易时不允许持有股票。

对于状态转移方程中的 `T[i][k][0]`，第 `i` 天进行的操作只能是**休息**或**卖出**，因为在第 `i` 天结束时持有的股票数量是 `0`。`T[i - 1][k][0]` 是**休息**操作可以得到的最大收益，`T[i - 1][k][1] + prices[i]` 是**卖出**操作可以得到的最大收益。注意到允许的最大交易次数是不变的，因为每次交易包含两次成对的操作，**买入**和**卖出**。只有**买入**操作会改变允许的最大交易次数。

对于状态转移方程中的 `T[i][k][1]`，第 `i` 天进行的操作只能是**休息**或**买入**，因为在第 `i` 天结束时持有的股票数量是 `1`。T[i - 1][k][1]` 是**休息**操作可以得到的最大收益，`T[i - 1][k - 1][0] - prices[i] 是**买入**操作可以得到的最大收益。注意到允许的最大交易次数减少了一次，因为每次**买入**操作会使用一次交易。

为了得到最后一天结束时的最大收益，可以遍历股票价格数组，根据状态转移方程计算 `T[i][k][0]` 和 `T[i][k][1]` 的值。最终答案是 `T[n - 1][k][0]`，因为结束时持有 `0` 份股票的收益一定大于持有 `1` 份股票的收益。