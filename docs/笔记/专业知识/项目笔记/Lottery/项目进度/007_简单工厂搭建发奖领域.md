# ç®€å•å·¥å‚æ­å»ºå‘å¥–é¢†åŸŸ

æˆªæ­¢åˆ°ç›®å‰æˆ‘ä»¬å¼€å‘å®ç°çš„éƒ½æ˜¯å…³äº `domain` é¢†åŸŸå±‚çš„å»ºè®¾ï¼Œå½“å„é¡¹æ ¸å¿ƒçš„é¢†åŸŸæœåŠ¡å¼€å‘å®Œæˆä»¥åï¼Œåˆ™ä¼šåœ¨ `application` å±‚åšæœåŠ¡ç¼–æ’æµç¨‹å¤„ç†çš„å¼€å‘ã€‚

ä¾‹å¦‚ï¼šä»ç”¨æˆ·å‚ä¸æŠ½å¥–æ´»åŠ¨ã€è¿‡æ»¤è§„åˆ™ã€æ‰§è¡ŒæŠ½å¥–ã€å­˜æ”¾ç»“æœã€å‘é€å¥–å“ç­‰å†…å®¹çš„é“¾è·¯å¤„ç†

æ¶‰åŠçš„é¢†åŸŸå¦‚ä¸‹ï¼š

<img src="https://happychan.oss-cn-shenzhen.aliyuncs.com/img/image-20220217232044508.png" alt="image-20220217232044508" style="zoom: 67%;" />

## å·¥ç¨‹ç»“æ„

```basic
lottery-domain
â””â”€â”€ src
    â””â”€â”€ main
        â””â”€â”€ java
		â””â”€â”€ cn.happy.lottery.domain.award
                â”œâ”€â”€ model
                â”œâ”€â”€ repository
                â”‚   â”œâ”€â”€ impl
                â”‚   â”‚   â””â”€â”€ AwardRepository
                â”‚   â””â”€â”€ IAwardRepository
                â””â”€â”€ service
                    â”œâ”€â”€ factory
                    â”‚   â”œâ”€â”€ DistributionGoodsFactory.java
                    â”‚   â””â”€â”€ GoodsConfig.java
                    â””â”€â”€ goods
                        â”œâ”€â”€ impl
                        â”‚   â”œâ”€â”€ CouponGoods.java
                        â”‚   â”œâ”€â”€ DescGoods.java
                        â”‚   â”œâ”€â”€ PhysicalGoods.java
                        â”‚   â””â”€â”€ RedeemCodeGoods.java
                        â”œâ”€â”€ DistributionBase.java
                        â””â”€â”€ IDistributionGoodsc.java
```

å…³äº award å‘å¥–é¢†åŸŸä¸­ä¸»è¦çš„æ ¸å¿ƒå®ç°åœ¨äº service ä¸­çš„ä¸¤å—åŠŸèƒ½é€»è¾‘å®ç°ï¼Œåˆ†åˆ«æ˜¯ï¼š`goods å•†å“å¤„ç†`ã€`factory å·¥å‚ğŸ­`

goodsï¼šåŒ…è£…é€‚é…å„ç±»å¥–å“çš„å‘æ”¾é€»è¾‘ï¼Œè™½ç„¶æˆ‘ä»¬ç›®å‰çš„æŠ½å¥–ç³»ç»Ÿä»…æ˜¯ç»™ç”¨æˆ·è¿”å›ä¸€ä¸ªä¸­å¥–æè¿°ï¼Œä½†åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæ˜¯çœŸå®çš„è°ƒç”¨ä¼˜æƒ åˆ¸ã€å…‘æ¢ç ã€ç‰©æµå‘è´§ç­‰æ“ä½œï¼Œè€Œè¿™äº›å†…å®¹ç»è¿‡å°è£…åå°±å¯ä»¥åœ¨è‡ªå·±çš„å•†å“ç±»ä¸‹å®ç°äº†ã€‚

factoryï¼šå·¥å‚æ¨¡å¼é€šè¿‡è°ƒç”¨æ–¹æä¾›å‘å¥–ç±»å‹ï¼Œè¿”å›å¯¹åº”çš„å‘å¥–æœåŠ¡ã€‚é€šè¿‡è¿™æ ·ç”±å…·ä½“çš„å­ç±»å†³å®šè¿”å›ç»“æœï¼Œå¹¶åšç›¸åº”çš„ä¸šåŠ¡å¤„ç†ã€‚ä»è€Œä¸è‡³äºè®©é¢†åŸŸå±‚åŒ…è£…å¤ªå¤šçš„é¢‘ç¹å˜åŒ–çš„ä¸šåŠ¡å±æ€§ï¼Œå› ä¸ºå¦‚æœä½ çš„æ ¸å¿ƒåŠŸèƒ½åŸŸæ˜¯åœ¨åšä¸šåŠ¡é€»è¾‘å°è£…ï¼Œå°±ä¼šå°±ä¼šå˜å¾—éå¸¸åºå¤§ä¸”æ··ä¹±

## è®¾è®¡æ€è·¯

![image-20220217232449645](https://happychan.oss-cn-shenzhen.aliyuncs.com/img/image-20220217232449645.png)



## å¼€å‘è¯´æ˜

- lottery-domainï¼šæ–°å¢ award å‘å¥–é¢†åŸŸå»ºè®¾
- lottery-commonï¼šConstant ä¸­å¼•å…¥å¯¹å‘å¥–çŠ¶æ€ AwardStateã€å¥–å“ç±»å‹ AwardType çš„æšä¸¾å®šä¹‰
- lottery-interfacesï¼šå•å…ƒæµ‹è¯•

## å‘å¥–é€‚é…ç­–ç•¥

**å®šä¹‰å¥–å“é…é€æ¥å£**

```java
public interface IDistributionGoods {

    /**
     * å¥–å“é…é€æ¥å£ï¼Œå¥–å“ç±»å‹ï¼ˆ1:æ–‡å­—æè¿°ã€2:å…‘æ¢ç ã€3:ä¼˜æƒ åˆ¸ã€4:å®ç‰©å¥–å“ï¼‰
     *
     * @param req   ç‰©å“ä¿¡æ¯
     * @return      é…é€ç»“æœ
     */
    DistributionRes doDistribution(GoodsReq req);

}
```

- æŠ½å¥–ï¼ŒæŠ½è±¡å‡ºé…é€è´§ç‰©æ¥å£ï¼ŒæŠŠå„ç±»å¥–å“æ¨¡æ‹Ÿæˆè´§ç‰©ã€é…é€ä»£è¡¨ç€å‘è´§ï¼ŒåŒ…æ‹¬è™šæ‹Ÿå¥–å“å’Œå®ç‰©å¥–å“

**å®ç°å‘é€å¥–å“ï¼šCouponGoodsã€DescGoodsã€PhysicalGoodsã€RedeemCodeGoods**

```java
@Component
public class CouponGoods extends DistributionBase implements IDistributionGoods {

    @Override
    public DistributionRes doDistribution(GoodsReq req) {

        // æ¨¡æ‹Ÿè°ƒç”¨ä¼˜æƒ åˆ¸å‘æ”¾æ¥å£
        logger.info("æ¨¡æ‹Ÿè°ƒç”¨ä¼˜æƒ åˆ¸å‘æ”¾æ¥å£ uIdï¼š{} awardContentï¼š{}", req.getuId(), req.getAwardContent());

        // æ›´æ–°ç”¨æˆ·é¢†å¥–ç»“æœ
        super.updateUserAwardState(req.getuId(), req.getOrderId(), req.getAwardId(), Constants.AwardState.SUCCESS.getCode(), Constants.AwardState.SUCCESS.getInfo());

        return new DistributionRes(req.getuId(), Constants.AwardState.SUCCESS.getCode(), Constants.AwardState.SUCCESS.getInfo());
    }

}
```

- ç”±äºæŠ½å¥–ç³»ç»Ÿå¹¶æ²¡æœ‰çœŸçš„ä¸å¤–éƒ¨ç³»ç»Ÿå¯¹æ¥ï¼Œæ‰€ä»¥åœ¨ä¾‹å¦‚ä¼˜æƒ åˆ¸ã€å…‘æ¢ç ã€å®ç‰©å‘è´§ä¸Šåªèƒ½é€šè¿‡æ¨¡æ‹Ÿçš„æ–¹å¼å±•ç¤ºã€‚å¦å¤–å››ç§å‘å¥–æ–¹å¼åŸºæœ¬ç±»ä¼¼ï¼Œå¯ä»¥å‚è€ƒæºç ã€‚

## å®šä¹‰ç®€å•å·¥å‚

**å·¥å‚é…ç½®**

```java
public class GoodsConfig {

    /** å¥–å“å‘æ”¾ç­–ç•¥ç»„ */
    protected static Map<Integer, IDistributionGoods> goodsMap = new ConcurrentHashMap<>();

    @Resource
    private DescGoods descGoods;

    @Resource
    private RedeemCodeGoods redeemCodeGoods;

    @Resource
    private CouponGoods couponGoods;

    @Resource
    private PhysicalGoods physicalGoods;

    @PostConstruct
    public void init() {
        goodsMap.put(Constants.AwardType.DESC.getCode(), descGoods);
        goodsMap.put(Constants.AwardType.RedeemCodeGoods.getCode(), redeemCodeGoods);
        goodsMap.put(Constants.AwardType.CouponGoods.getCode(), couponGoods);
        goodsMap.put(Constants.AwardType.PhysicalGoods.getCode(), physicalGoods);
    }

}
```

- æŠŠå››ç§å¥–å“çš„å‘å¥–ï¼Œæ”¾åˆ°ä¸€ä¸ªç»Ÿä¸€çš„é…ç½®æ–‡ä»¶ç±» Map ä¸­ï¼Œä¾¿äºé€šè¿‡ AwardType è·å–ç›¸åº”çš„å¯¹è±¡ï¼Œå‡å°‘ `if...else` çš„ä½¿ç”¨ã€‚

**å·¥å‚ä½¿ç”¨**

```java
@Service
public class DistributionGoodsFactory extends GoodsConfig {

    public IDistributionGoods getDistributionGoodsService(Integer awardType){
        return goodsMap.get(awardType);
    }

}
```

- é…é€å•†å“ç®€å•å·¥å‚ï¼Œæä¾›è·å–é…é€æœåŠ¡ã€‚

## æµ‹è¯•éªŒè¯

```java
@Test
public void test_award() {
    // æ‰§è¡ŒæŠ½å¥–
    DrawResult drawResult = drawExec.doDrawExec(new DrawReq("happy", 10001L));

    // åˆ¤æ–­æŠ½å¥–ç»“æœ
    if (Constants.DrawState.FAIL.getCode().equals(drawResult.getDrawState())) {
        logger.info("æœªä¸­å¥– DrawAwardInfo is null");
        return;
    }

    // å°è£…å‘å¥–å‚æ•°ï¼ŒorderIdï¼š2109313442431 ä¸ºæ¨¡æ‹ŸIDï¼Œéœ€è¦åœ¨ç”¨æˆ·å‚ä¸é¢†å¥–æ´»åŠ¨æ—¶ç”Ÿæˆ
    DrawAwardInfo drawAwardInfo = drawResult.getDrawAwardInfo();
    GoodsReq goodsReq = new GoodsReq(drawResult.getuId(), "2109313442431", drawAwardInfo.getAwardId(), drawAwardInfo.getAwardName(), drawAwardInfo.getAwardContent());

    // æ ¹æ® awardType ä»æŠ½å¥–å·¥å‚ä¸­è·å–å¯¹åº”çš„å‘å¥–æœåŠ¡
    IDistributionGoods distributionGoodsService = distributionGoodsFactory.getDistributionGoodsService(drawAwardInfo.getAwardType());
    DistributionRes distributionRes = distributionGoodsService.doDistribution(goodsReq);

    logger.info("æµ‹è¯•ç»“æœï¼š{}", JSON.toJSONString(distributionRes));
}
```

### æµ‹è¯•ç»“æœ

```java
2022-02-18 07:55:39.629  INFO 24388 --- [           main] c.h.l.d.s.s.draw.impl.DrawExecImpl       : æ‰§è¡ŒæŠ½å¥–ç­–ç•¥ strategyIdï¼š10001ï¼Œæ— åº“å­˜æ’é™¤å¥–å“åˆ—è¡¨IDé›†åˆ awardIdListï¼š["1","4"]
2022-02-18 07:55:39.635  INFO 24388 --- [           main] c.h.l.d.s.service.draw.AbstractDrawBase  : æ‰§è¡Œç­–ç•¥æŠ½å¥–å®Œæˆã€å·²ä¸­å¥–ã€‘ï¼Œç”¨æˆ·ï¼šhappy ç­–ç•¥IDï¼š10001 å¥–å“IDï¼š3 å¥–å“åç§°ï¼šipad
2022-02-18 07:55:39.638  INFO 24388 --- [           main] c.h.l.d.a.s.goods.DistributionBase       : TODO åæœŸæ·»åŠ æ›´æ–°åˆ†åº“åˆ†è¡¨ä¸­ï¼Œç”¨æˆ·ä¸ªäººçš„æŠ½å¥–è®°å½•è¡¨ä¸­å¥–å“å‘å¥–çŠ¶æ€ uIdï¼šhappy
2022-02-18 07:55:39.795  INFO 24388 --- [           main] cn.happy.lottery.test.SpringRunnerTest   : æµ‹è¯•ç»“æœï¼š{"code":1,"info":"å‘å¥–æˆåŠŸ","uId":"happy"}
```

- ä»æµ‹è¯•ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œå…ˆæ˜¯æ‰§è¡Œäº†æˆ‘ä»¬å·²ç»å¼€å‘å¥½äº†çš„æŠ½å¥–é¢†åŸŸæœåŠ¡ï¼Œä¹‹åæ‰§è¡Œå‘å¥–æ“ä½œã€‚ä¸è¿‡ç›®å‰çš„å‘å¥–è¿˜æ²¡æœ‰å¯¹ä¸ªäººç”¨æˆ·è¡¨ä¿¡æ¯æ›´æ–°ï¼Œè¿™éƒ¨åˆ†å†…å®¹åœ¨æˆ‘ä»¬åç»­å¼€å‘åˆ†åº“åˆ†è¡¨é€»è¾‘çš„æ—¶å€™ï¼Œè¡¥å……æ·»åŠ ä¸Šã€‚

## æ€»ç»“

1. æœ¬ç« èŠ‚æ³¨æ„åº“è¡¨å­—æ®µçš„è°ƒæ•´ï¼Œå¦‚æœä½ æ˜¯ä¹‹å‰çš„åº“è¡¨éœ€è¦æ›´æ–°ã€‚
2. å­¦ä¹ ç®€å•å·¥å‚æ¨¡å¼çš„ä½¿ç”¨ï¼Œåˆ©ç”¨å·¥å‚æ¨¡å¼+æ¥å£å°è£…å¥–å“ï¼Œè®©æ¯ä¸€å—åŠŸèƒ½éƒ½æ›´åŠ æ¸…æ™°æ˜“äºæ‰©å±•å’Œç»´æŠ¤ã€‚
3. ç®€å•å·¥å‚æ¨¡å¼é¿å…åˆ›å»ºè€…ä¸å…·ä½“çš„äº§å“é€»è¾‘è€¦åˆã€æ»¡è¶³å•ä¸€èŒè´£ï¼Œæ¯ä¸€ä¸ªä¸šåŠ¡é€»è¾‘å®ç°éƒ½åœ¨æ‰€å±è‡ªå·±çš„ç±»ä¸­å®Œæˆã€æ»¡è¶³å¼€é—­åŸåˆ™ï¼Œæ— éœ€æ›´æ”¹ä½¿ç”¨è°ƒç”¨æ–¹å°±å¯ä»¥åœ¨ç¨‹åºä¸­å¼•å…¥æ–°çš„äº§å“ç±»å‹ã€‚ä½†è¿™æ ·ä¹Ÿä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚æœ‰éå¸¸å¤šçš„å¥–å“ç±»å‹ï¼Œé‚£ä¹ˆå®ç°çš„å­ç±»ä¼šæé€Ÿæ‰©å¼ ï¼Œå¯¹äºè¿™æ ·çš„åœºæ™¯å°±éœ€è¦åœ¨å¼•å…¥å…¶ä»–è®¾è®¡æ‰‹æ®µè¿›è¡Œå¤„ç†ï¼Œä¾‹å¦‚æŠ½è±¡é€šç”¨çš„å‘å¥–å­é¢†åŸŸï¼Œè‡ªåŠ¨åŒ–é…ç½®å¥–å“å‘å¥–ã€‚















