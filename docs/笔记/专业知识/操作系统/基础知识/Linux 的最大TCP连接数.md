## Reference
- https://readmedium.com/devops-in-linux-maximum-tcp-connections-in-a-linux-server-98af6ff65a4c
- 

Linux 上万物皆是文件，能打开的连接数，也与能打开的文件数相关

一些控制连接数的内核参数或者命令

``` 
# 查看Linux系统用户最大打开文件限制数
ulmit -n 

# /etc/sysctl.conf
fs.file-max=1100000  # 系统性的限制，能打开的最大文件数
fs.nr_open=1100000   # 单进程能打开的最大文件数

# /etc/security/limits/conf
soft nofile 1000000  # 单个进程一次性能打开的文件数
hard nofile 1000000  # 要大于 soft


```

如何标识一个 TCP 连接？
- 四元组：（源IP：目的IP：源端口：目的端口）

从服务端来看：
- 四元组的构成，最多的组合为 IP * 端口，也就是 2^32 * 2^16 ，但实际上，每建立一个 TCP 连接，就需要在内核中维护一个数据结构来存储它的状态；在只考虑 TCP 状态为 ESTABLISH 的情况下，假设每个连接占用 3.3KB，则一个 4GB 内存的服务器，可以建立1,271,000+ 个连接（在不考虑其他资源消耗的情况下）

从客户端来看：
- 每个连接都需要占用一个端口，能够建立的连接数，取决于机器的端口号有多少，端口范围为[0 ~ 65535] ，但是这并不意味着客户端最多能建立65535个连接；
- 如果客户端只有一个IP，服务器也只有一个IP且只有一个程序在运行/监听，并且只监听一个端口的情况下，客户端与服务器之间最多能建立的连接数为`65535`
- 如果一个客户端有多个IP（假设客户端有`n`IP），服务端只有一个IP且只运行一个程序，监听一个端口，则一个客户端机器最大能建立的连接数为：`n * 65535`
- 假如一个客户端只有一个IP，服务器也只有一个IP，但是服务器运行了多个程序（m个程序），每个程序监听一个端口，那么一个客户端机器能建立的最大连接数为：`65535 * m`

实际工作中遇到的问题以及如何解决：

1、一个网关服务，负责接受底下众多代理的心跳上报，每一个心跳请求，就是一个不同的客户端，需要与网关服务建立TCP连接，一开始发现是网关服务处理不过来，然后不断增加pod数来缓解接口压力，但这并不是一个线性增长的过程，后续接口开始报拒绝连接，too many open file了， 线上就先通过调整部署 deployment 的yaml ，修改 sysctl.net.maxconn 为 1024 来提升每个pod能建立的连接个数 
![image.png](https://happychan.oss-cn-shenzhen.aliyuncs.com/picgo/20241221101922.png)
2、可以参考 [[]]