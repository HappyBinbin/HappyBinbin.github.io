# 抽奖活动策略库表设计

一个满足业务需求的抽奖系统，需要提供抽奖活动配置、奖品概率配置、奖品梳理配置等内容，同时用户在抽奖后需要记录用户的抽奖数据，这就是一个抽奖活动系统的基本诉求。

那么为了满足这个诉求，我们可以提供表包括：

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20211214165341334.png" alt="image-20211214165341334" style="zoom:80%;" />

- 活动配置，activity：提供活动的基本配置
- 策略配置，strategy：用于配置抽奖策略，概率、玩法、库存、奖品
    - 策略明细，strategy_detail：抽奖策略的具体明细配置	
- 奖品配置，award：用于配置具体可以得到的奖品
- 用户参与活动记录表，user_take_activity：每个用户参与活动都会记录下他的参与信息，时间、次数
- 用户活动参与次数表，user_take_activity_count：用于记录当前参与了多少次
- 用户策略计算结果表，user_strategy_export_001~004：最终策略结果的一个记录，也就是奖品中奖信息的内容



## 问题思考

1、活动表和策略表的关联，是将活动ID 写入抽奖策略表中还是将抽奖策略ID 写入活动表中？

> 不同业务场景，不同分析

- 将活动ID 写入抽奖策略表：这样会将策略与活动进行绑定，在构建抽奖策略时，必须得现有活动才能进行构建，不具备灵活性
- 将策略ID 写入活动表：将抽奖策略相关（抽奖策略表、策略明细、奖品配置构建成一个服务领域），让策略以一种“配置”的概念单独存在，以供给不同的活动或者外部引用

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20220203135649430.png" alt="image-20220203135649430" style="zoom:80%;" />

2、strategy_detail这张表award_count（奖品库存）、award_surplus_count（奖品剩余库存）这两个字段是不是放在award（奖品表）比较好呢？

因为如果多个strategy_id，对应同一个奖品，那么有一个strategy_id发放奖品更新库存数量，这多个strategy_id对应的记录都需要更新这个奖品对应的库存数量。

![image-20220219124453288](https://gitee.com/HappyBinbin/pcigo/raw/master/image-20220219124453288.png)

而且strategy_detail表冗余了award_name（商品名称）字段，三个商品相关字段放在这个表里是为了省去关联商品表从而提升查询效率，所以这样设计吗？不过这样设计的话不满足数据库的第三范式了。

1. 在实际的场景中，抽奖系统与发奖系统是隔离的，抽奖计算结果，发奖执行动作。所以两方库存也是隔离的，不太可能从抽奖到发奖做一个大事务，那么如果抽奖中没有库存，只是计算结果，就会导致发奖中库存超发的情况。这有点像电商中商品的售卖和对应sku的库存，售卖系统是需要一个库存闲置的，sku库存是总库存，二者隔离。 
2. strategy_detail 添加商品名称是为了冗余方便查询，也是为了扩展性更强，不一定商品名称就是直接给用户看到的名称，抽奖是营销类系统，可能有时候运营会加一些额外的展示字段在抽奖转盘页面上。另外有时候数据设计会反三范式设计
