## 项目介绍

![image-20220219114319218](https://gitee.com/HappyBinbin/pcigo/raw/master/image-20220219114319218.png)

## 技术问答

Q：

- 抽奖系统的服务是怎么划分的，划分成了哪些服务，怎么做分布式的部署？
- 这个项目能抗住多大的并发？

A：

1. 抽奖系统是占营销活动系统的一部分，整条链路基础的包括：一组核心业务系统(比如：商城、论坛、游戏都可以)、用户系统、账户系统、奖品系统
2. 流程上可以通过抽奖单对用户的积分账号进行扣减消耗，进行抽奖，抽奖完成后，进行奖品发放。PS：抽奖也可以类比商城下单；订单号、支付单、交易单、发货
3. 分布式部署，从用户系统、账户系统、抽奖系统、奖品系统等都部署多套，系统间使用 RPC 进行通信，对外网关层使用 HTTP 进行通信。
4. QPS 可以说是日常均值500-1000，活动运营集中push推送，峰值可达3000-5000 持续半分钟左右



Q：

- 在实际项目中，redis 和 zookeeper 实现分布式锁，哪个使用的多，为什么？各自有什么优缺点，为什么抽象系统不用 zookeeper 来实现分布式锁？

A：

1. 从运维成本回答：如果公司已经有一套非常稳定的 Redis 集群，而 ZK 需要自己搭建维护，那么就使用 Redis 
2. 从技术实现回答：目前 Redis 在抽奖系统中使用的分布式锁，是分段滑块锁，降低锁的颗粒度。如果使用 ZK 也实现同样的方案，会需要频繁的创建节点删除节点，性能比不上缓存锁。
3. 从业务场景回答：因为我们的场景是抽奖系统，并不是下单秒杀，可以在一定程度只保证不超卖即可。如果是需要非常强一致性的下单支付类场景，ZK 的加锁稳定性会比 Redis 更可靠一些，不过也可以通过通过加强 Redis 的集群来解决此问题。
4. 综上：以结合实际的业务场景诉求，结合公司实际情况，在最低运维成本下，完成业务需求，降低研发成本，提高交付质量



Q：

- 抽象系统中，如果扣减库存成功了，而后续的步骤因为出现了活动异常的情况，但是这个扣减库存是已经完成，不会再返回的，有什么容错的机制吗？

A：

1. 【背景】其实按照运营来看，是会配置出一定数量的参与抽奖活动，但不会得到奖品的用户
2.  当然可能根据不同的业务诉求，不同的风险级别，有些场景是需要30分钟内未支付/未交易/未抽奖等，进行分布式扫描库表扭转订单/抽奖单状态，恢复库存操作
3. 因为我们这场景是不需要这样的处理，参与失败的用户也证明是参与了，可以进行第二次抽奖，再发起抽奖的时候会查询到以往的抽奖单信息执行抽奖



Q：

- Q1：项目的并发瓶颈在哪？用了什么手段去解决？在未来要进行优化会怎么做？
- Q2：目前我们就是把库存分散到了不同的redis分片中，但是存在一个问题：hash取模得到的redis分片没有库存时，但是其他的分片是有库存的。这块还得考虑迁移到其他分片去扣库存。

A：

1. 早期对于抽奖的库存扣减是依赖于数据库行级锁的，后来因为业务流量较大，优化为 Redis 分布式锁。但因为锁的方式使用的是独占竞态锁，所有流量打到一个 Key 上进行秒杀处理，容易造成死锁风险，后优化为分段竞态锁，降低锁的颗粒度，提供高可用。 
2. 可以实现一个 Redis 路由组件，如果未来对于这块的热key、秒杀库存极限等瓶颈问题，还可以把库存数据分散到不同的 Redis 服务中。 
3. 还可以再聊一下延迟发奖的瓶颈，需要指定某个时间点，同时发奖，这里包括了低延迟任务的处理，需要把数据库的任务数据提前预热到Redis进行消费，详细：[方案设计：基于库表分段扫描和数据Redis预热，优化分布式延迟任务触达时效性](https://mp.weixin.qq.com/s/jJ0vxdeKXHiYZLrwDEBOcQ)
4. 会有Q2这种情况，通常会提供一个路由列表，在一个库存消耗尽时，会从路由列表移除，直至全部清空。PS：这里也会配置是否允许动态调整，以满足不同的业务诉求，有些是允许A可以秒杀，B秒杀不到的场景。

Q：Redis 是单机的吗？如果是单机的话，Redis 分布式锁会有什么问题？

Q：为什么选用 Kafka，不用 RabbitMQ 或者 RocketMQ？他们有什么区别？

Q：为什么用 DDD，有什么优势？

Q：消息队列怎么处理数据的一致性？处理数据一致性的消息发送，在 Redis 的分布式锁范围内吗？

Q：分布式锁的过期时间是多少？

Q：事务性消息？

Q：多数据库间数据一致性处理？

Q：为什么分库分表操作的表修改不在业务层做，而是反射获取表名并修改？

Q：为什么使用Redis分布式锁，而不是原子的库存扣减？

Q： 面试：问分库分表，别给我回答分2个库，每个库4个表，那你分那个毛用，一看就是假的。 问：为什么不根据时间来分库分表，而是根据人员ID来分库分表，后期数据量大怎么扩容？ 答： 1. 根据时间做，需要按照时间分片进行处理，比较适合处理冷数据。 2. 目前抽奖系统为实时业务数据，如果基于时间分片处理带来的问题是，当一个用户请求进来做业务，很难定位这个用户所属的库表，也包括一些基于人维度的事务处理。 3. 一般基于用户ID所做的分库分表，会根据业务体量的发展设定一个2-3年增量的分库分表规模。比如每个库32张表，分4个库。(PS：这里不要说就4个表、8个表，那你分表还有个P用) 4. 为了因分库分表所带来的服务器资源占用数量，会采用虚机操作，一般一台标C的物理机，进行1虚5的配置进行处理，这样在后续第一波业务爆发增长的时候，可以把虚机换为物理机，这个时候是不需要迁移数据的，成本较低。 5. 当后期数据量较大的时候，采用binlog+canal同步数据的方式进行扩容，并逐步把新数据写入到新库中，当两方数据库完全同步后，开始重启实例进行切换。当然这个成本和风险是会有的，但随着我们的整个流程完整度的提高，在公司内部已经成为标准SOA作业。 6. 当然我们还有一些额外的考虑，怎么做到自动扩展，针对这方面我们目前开始尝试给用户生成的ID中写入库表信息，这个信息是加密的，随着用户量的增多自动扩展数据库表，随着用户体量的增加，挂在后新的用户就可以注册到新库表了。另外，我们还思考，把数据库的路由前置到RPC层，解决数据库笛卡尔积交叉链接的问题，当然这是另外一个场景了，这里就不做过多的扩展了，面试官你看还有其他问题吗。





Q&A：

1.活动表中总库存的概念是什么？

- 总库存相当于活动的运营配置的预算库存梳理，基本一次活动满足多少人参加，做一个控制。不能无限制的参加

2.奖品的库存和这个总库存的联系又是什么？       

- 总库存大于奖品库存，参加活动只代表有了一个名额，但是否中奖要看奖品库存

3.如果抽奖领域中是单奖模式，抽到没有库存的奖品，会回滚总库存吗？因为我个人认为总库存＝ 各奖品的库存之和

- 不会回滚，抽奖到没库存的，就提示未中奖了。总概率的会把概率分配给其他奖品，最终一定能中奖

4.如果说每次抽奖都能抽到奖品，即使没有奖品，也能发兜底奖品，这种情况下总库存是不是就没有了意义

- 有意义的，一般兜底奖品都是些没有成本的，可能就是很低的满减券，一些引流商品的优惠券等 





Q： 

在项目类、接口设计方面很薄弱如何提升这方面？

A：

如果你想提升这方面的技能，可以参考以下几点： 

1. 【吸收】阅读有框架结构的代码，或者如 Spring、Mybatis 这样的源码，并亲自动手去编写。

2. 【规范】在每次系统开发前，多思考、多设计，最后才是编码。要把设计内容落到 xmind、ppt、visio上，出对应的架构图、拓扑图、思维导图、系统关系图、类图等。当然也应该更注重开发规范，用每次学到的经验更好的在代码中有所体现，这一次肯定要比上一次更好的追求，才是工匠精神。 
3. 【业务】想设计出更好的系统，更优雅的架构，更有扩展的服务，那么研发就不应该只是做研发的事情，还需要更多的去参与到业务、运营、产品会中，从大家的交流中制定系统战略方向，这样才能在你后续的战术实现上，更加贴合业务。也能更好的作出一些符合现在和后续扩展的接口和服务，也能更清楚的知道如何提炼一些共性的领域，让其可以复用。因为我们要知道，解决复杂场景的设计主要分为：分治、抽象和知识。只有在系统分治层面合理切割问题空间为更小规模的若干子问题，问题越小就容易被理解和处理，最终做到高内聚低耦合。
4. 【拓展】尝试开发一些有深度的技术内容，比如凝练业务中的共性功能，实现一些 SpringBoot Starter，这能提升你的逻辑抽象思维，锻炼系统组件设计能力。
5. 【攀升】手动的去编写一些 RPC、MQ、网关等各类你已经正在使用的服务，因为它们已经有了非常明确的标准，按照标准去思考和实现是一个很好的学习过程。当然这有一定的难度，可能不一定能在短时间内完成，但只要坚持一定能完成。 
6. 【其他】补全一些标准的接口设计文档，比如要有明确的出参、入参、方法名称，以及这些接口哪些是共用的，哪些是会频繁变动不稳定的。PS：最后这点看似是最应该做的，但能做好这条的前提是沉淀和积累了很多的复杂架构设计经验和工程落地能力。





























