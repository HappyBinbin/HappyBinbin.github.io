# 10. RDB持久化

持久化的意思是将数据永久保存在磁盘中。Redis采用RDB和AOF两种策略。将服务器中的非空数据库以及它们的键值对统称为**数据库状态**。下图三个非空数据库，以及其中的键值对就是该服务器的数据库状态。

[![img](https://camo.githubusercontent.com/0370238c1f4a8a1ec21d778a16052719b7729c85b45716c53c897bf7f411aa21/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130343134323134382e706e67)](https://camo.githubusercontent.com/0370238c1f4a8a1ec21d778a16052719b7729c85b45716c53c897bf7f411aa21/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130343134323134382e706e67)

在Redis中，只有将数据保存在内存磁盘里才会永久保存，**如果服务器进程退出，服务器中的数据库状态就会消失。**为了解决这个问题，Redis提供了RDB持久化功能，这个功能可以将Redis在内存中的数据库状态保存到磁盘里面。

RDB持久化产生的RDB文件(Redis Database)是一个**经过压缩的二进制文件，该文件可以被还原为数据库状态**，所以即使服务器停机，服务器的数据还是被安全保存在硬盘中。

## 10.1 RDB文件的创建与载入

有两个Redis命令可以用于生成RDB文件，一个是**SAVE**，另一个是**BGSAVE (BackGround SAVE)。**SAVE命令会阻塞Redis服务器进程，直到RDB文件创建完毕为止，在服务器进程阻塞期间，服务器不能处理任何命令请求：

```sql
redis> SAVE //等待直到RDB文件创建完毕
OK
```

而BGSAVE命令会**增加一个子进程**，负责创建RDB文件。

```sql
redis> BGSAVE //派生子进程，并由子进程创建RDB文件
Background saving started
```

BGSAVE执行时，会阻止SAVE、其他BGSAVE和BGREWRITEAOF这三个命令执行，防止竞争。

创建RDB文件的实际工作由`rdb.c/rdbSave`函数完成，SAVE命令和BGSAVE命令会以不同的方式调用这个函数。

<hr>
Redis并没有载入RDB文件的命令，只要服务器启动时**检测到RDB文件存在，他就会自动载入。**比如下面日志的第二条：

[![img](https://camo.githubusercontent.com/179ec49b5624c499a2ac50278ea4e3af71ca80e12347f14775f97f3add640ac9/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130343135343833342e706e67)](https://camo.githubusercontent.com/179ec49b5624c499a2ac50278ea4e3af71ca80e12347f14775f97f3add640ac9/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130343135343833342e706e67)

## 10.2 自动间隔性保存

### 10.2.1 设置保存条件

由于BGSAVE可以不阻塞服务器执行，所以我们可以**设置条件**，让服务器每隔一段时间自动保存。举个例子：

```sql
save 900 1
save 300 10
save 60 10000
```

这些条件的意思是：900秒内对数据库至少进行了1次修改，300秒内对数据库进行了10次修改....

服务器程序会根据save选项所设置的保存条件，设置服务器状态`redisServer`结构的`saveparams`属性：

```c
struct redisServer 
{ 
    // ... 
    // 记录了保存条件的数组 
    struct saveparam *saveparams; 
    // ...
};
```

`saveparams`属性是一个数组，数组中的每个元素都是一个`saveparam`结构，每个`saveparam`结构都保存了一个save选项设置的保存条件：

```c
struct saveparam 
{ 
    // 秒数 
    time_t seconds; 
    // 修改数 
    int changes;
};
```

![img](https://camo.githubusercontent.com/ffb15ba138864e8c8f10cd8fe44772e0bebc2188fc70a08a69330f23d9d6bd9b/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130343136313030372e706e67)



### 10.2.2 dirty 计数器和 lastsave 属性

除了设置保存条件的saveparams数组外，服务器状态还维持着一个**dirty计数器**，以及一个**lastsave属性**：

- dirty计数器记录自上一次SAVE和BGSAVE以后，服务器对数据库状态进行了多少次修改（包括增删改）
- lastsave则是一个时间戳，记录了上一次执行保存的时间。

当服务器执行修改命令一次以后，dirty计数器就加一。如果是一次性修改多个元素，计数器此时加N

```sql
redis->SADD database0 apple orange watermelon
```

### 10.2.3 检查保存条件是否满足

Redis的服务器**周期性操作函数serverCron默认每隔100毫秒就会执行一次**，该函数用于对正在运行的服务器进行维护，它的其中一项工作就是检查save选项所设置的保存条件是否已经满足，如果满足的话，就执行BGSAVE命令。

执行完以后，dirty清0，lastsave更新。

## 10.3 RDB文件结构

完整的RDB文件如下，

[![img](https://camo.githubusercontent.com/0485c8f753cbb2a385342003774ea95f81422d11748bd9bef741dabe9cfdf5f7/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130343136323534302e706e67)](https://camo.githubusercontent.com/0485c8f753cbb2a385342003774ea95f81422d11748bd9bef741dabe9cfdf5f7/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130343136323534302e706e67)

RDB是一个二进制文件而不是文本文件。

> 广义来说，所有文件都是二进制文件。狭义来说，文本文件是基于字符编码的文件，常见的编码有**ASCII编码，UNICODE编码**等等；二进制文件是基于值编码的文件，也可以理解为**自定义编码。**

- 开头的REDIS占5个字节，这5个字符**用于检查是不是RDB文件。**
- db_version长度为4字节，值被解析为**RDB版本**，比如"0006"就代表第6版。
- database部分包含着**多个数据库的键值对数据**，根据大小不同，长度有所不同。
- EOF占1个字节，结束位标志。
- check_sum是占8字节，保存**校验和**。服务器在载入时会根据读入的实际数据计算出一个数来和校验值比较，以此来检查是否有损坏。

### 10.3.1 database部分

每个非空数据库在RDB文件中都可以保存为`SELECTDB`、`db_number`、`key_value_pairs`三个部分，如图所示。

[![img](https://camo.githubusercontent.com/4766ef78c8f7ea61ed02f1eedb395094f0cf2f88516e639354adb4eee4b60e94/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130313234362e706e67)](https://camo.githubusercontent.com/4766ef78c8f7ea61ed02f1eedb395094f0cf2f88516e639354adb4eee4b60e94/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130313234362e706e67)

- `SELECTDB`常量，1字节，当读取到此值时，程序知道接下来要读入一个数据库号码。
- `db_number`，1、2、5字节，保存数据库号码。
- `key_value_pairs`，保存键值对，包括过期时间。

### 10.3.2 key_value_pairs部分

不带过期时间的键值对在RDB文件中由TYPE、key、value三部分组成

[![img](https://camo.githubusercontent.com/753194236f6d200feb12384e0d9785f11b022d5bd5220ad83833699dc492397d/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130313534382e706e67)](https://camo.githubusercontent.com/753194236f6d200feb12384e0d9785f11b022d5bd5220ad83833699dc492397d/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130313534382e706e67)

带有过期时间的键值对在RDB中的结构如下

[![img](https://camo.githubusercontent.com/90e05e8ed005b36384e1fd7cf505720783167fe3f24d7a775e13a823585fda90/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130313731332e706e67)](https://camo.githubusercontent.com/90e05e8ed005b36384e1fd7cf505720783167fe3f24d7a775e13a823585fda90/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130313731332e706e67)

- EPIRETIME_MS，1字节，告诉程序接下来读取一个以毫秒为单位的过期时间。
- ms，8字节带符号整数，记录一个以毫秒为单位的UNIX时间戳。

### 10.3.3 value部分

#### 1. 字符串对象

如果TYPE的值为`REDIS_RDB_TYPE_STRING`，那么value保存的就是一个字符串对象，字符串对象的编码可以是`REDIS_ENCODING_INT`或者`REDIS_ENCODING_RAW`。

如果是INT，则表示对象是一个**长度不超过32位的整数**，保存方式如下：

[![img](https://camo.githubusercontent.com/23b5e5d5071e49ad3f63aaa963dbccc67e47b2a3f7d6207c424fa3d421fde9bf/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130333631332e706e67)](https://camo.githubusercontent.com/23b5e5d5071e49ad3f63aaa963dbccc67e47b2a3f7d6207c424fa3d421fde9bf/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130333631332e706e67)

其中，`ENCODING`的值可以是`REDIS_RDB_ENC_INT8`、`REDIS_RDB_ENC_INT16`或者`REDIS_RDB_ENC_INT32`三个常量的其中一个，它们分别代表RDB文件使用8位、16位或者32位来保存整数值integer。

如果是RAW格式，则说明对象是一个**字符串值**，有压缩和不压缩两种方法来保存。对于没有压缩的字符串（长度<=20字节），保存格式如下：

[![img](https://camo.githubusercontent.com/9fea3453cdb356e667e3c7ee527f992ce2ca39b6d6ac48a4f97656a971e281bc/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130333833342e706e67)](https://camo.githubusercontent.com/9fea3453cdb356e667e3c7ee527f992ce2ca39b6d6ac48a4f97656a971e281bc/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130333833342e706e67)

压缩后的字符串（长度>20字节），保存格式如下：

[![img](https://camo.githubusercontent.com/388601bcec728aa4b925acd517fb579ff218705b97c4857baab8941e568a0833/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130333835392e706e67)](https://camo.githubusercontent.com/388601bcec728aa4b925acd517fb579ff218705b97c4857baab8941e568a0833/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130333835392e706e67)

- REDIS_RDB_ENC_LZF，表明已被LZF算法压缩
- compressed_len，被压缩后的字符串长度
- origin_len，原来的长度
- compressed_string，被压缩后的字符串

#### 2. 列表对象

如果TYPE的值为`REDIS_RDB_TYPE_LIST`，那么value保存的就是一个`REDIS_ENCODING_LINKEDLIST`编码的列表对象，RDB文件保存这种对象的结构如图所示。[
![img](https://camo.githubusercontent.com/5339a28e25ea7073ed3e37020d42fd594f0eb96de1fd394dfb319dbc4609eb60/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130343232362e706e67)](https://camo.githubusercontent.com/5339a28e25ea7073ed3e37020d42fd594f0eb96de1fd394dfb319dbc4609eb60/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130343232362e706e67)

**每一个列表项都是一个字符串对象**，所以程序会以字符串对象的方式来保存。

[![img](https://camo.githubusercontent.com/fd6006f4abb5ab21ea4b9dc32d2fa25dbe1c64c989016ed2d4c866ea3dd8cce1/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130343431392e706e67)](https://camo.githubusercontent.com/fd6006f4abb5ab21ea4b9dc32d2fa25dbe1c64c989016ed2d4c866ea3dd8cce1/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130343431392e706e67)

结构中，3表示列表长度，5表示第一个列表项长度为5，内容为"hello"。

#### 3. 集合对象

如果TYPE的值为`REDIS_RDB_TYPE_SET`，那么value保存的就是一个`REDIS_ENCODING_HT`编码的集合对象，RDB文件保存这种对象的结构如图所示。

[![img](https://camo.githubusercontent.com/27505b9daf394e432875f14f628a3c3f68d5fb0a9323c604232202906e1e494c/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130343632372e706e67)](https://camo.githubusercontent.com/27505b9daf394e432875f14f628a3c3f68d5fb0a9323c604232202906e1e494c/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130343632372e706e67)

图中elem代表集合的元素，**每个集合元素都是一个字符串对象。**

[![img](https://camo.githubusercontent.com/847790d928ce0c76ceeaf9f258a36fd3517f0af506af8c78538b18d31d6a13b0/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130343731352e706e67)](https://camo.githubusercontent.com/847790d928ce0c76ceeaf9f258a36fd3517f0af506af8c78538b18d31d6a13b0/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130343731352e706e67)

和列表一样，4代表集合大小，5代表元素长度，值为"apple"。

#### 4. 哈希表对象

如果TYPE的值为`REDIS_RDB_TYPE_HASH`，那么value保存的就是一个`REDIS_ENCODING_HT`编码的集合对象，RDB文件保存这种对象的结构如图所示。

[![img](https://camo.githubusercontent.com/23379858c9e09a7b495dfda01df219535842c17775a997e5bc9cd8c10cc4e805/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130353134322e706e67)](https://camo.githubusercontent.com/23379858c9e09a7b495dfda01df219535842c17775a997e5bc9cd8c10cc4e805/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130353134322e706e67)

例子如下

[![img](https://camo.githubusercontent.com/626a26fcad112b3eb0e10a6dff1e4a8c33d58f54658c900547cd850e7c6bb171/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130353230382e706e67)](https://camo.githubusercontent.com/626a26fcad112b3eb0e10a6dff1e4a8c33d58f54658c900547cd850e7c6bb171/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130353230382e706e67)

哈希表长度为2，第一个键值对，键长度为1的字符串"a"，值为5的字符串"apple"。

#### 5. 有序集合对象

如果TYPE的值为`REDIS_RDB_TYPE_ZSET`，那么value保存的就是一个`REDIS_ENCODING_SKIPLIST`编码的有序集合对象，RDB文件保存这种对象的结构如图所示。

[![img](https://camo.githubusercontent.com/73b8879c1a81d867ebc7d6c048fb2fa0710fcd01699d2634b4a5fafe22c1b4a4/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130353635382e706e67)](https://camo.githubusercontent.com/73b8879c1a81d867ebc7d6c048fb2fa0710fcd01699d2634b4a5fafe22c1b4a4/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130353635382e706e67)

比如：

[![img](https://camo.githubusercontent.com/93a741c29d12281ea387d9b279c6260097fd289aff05b1e9bd8255e1e49b68b1/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130353732362e706e67)](https://camo.githubusercontent.com/93a741c29d12281ea387d9b279c6260097fd289aff05b1e9bd8255e1e49b68b1/68747470733a2f2f6275636b65742d313235393535353837302e636f732e61702d6368656e6764752e6d7971636c6f75642e636f6d2f32303230303130353130353732362e706e67)

大小为2，第一个元素是长度为2的字符串"pi"，分值被转换为长度为4的字符串"3.14"。

#### 6. INTSET编码的集合

如果TYPE的值为`REDIS_RDB_TYPE_SET_INTSET`，那么value保存的就是一个**整数集合对象**，RDB文件保存这种对象的方法是，**先将整数集合转换为字符串对象**，然后将这个字符串对象保存到RDB文件里面。

#### 7. ZIPLIST编码的列表、哈希表和有序集合

如果TYPE的值为`REDIS_RDB_TYPE_LIST_ZIPLIST`、`REDIS_RDB_TYPE_HASH_ZIPLIST`或者`REDIS_RDB_TYPE_ZSET_ZIPLIST`，那么value保存的就是一个**压缩列表对象**，保存策略和上面一一样：先转化为字符串对象。












