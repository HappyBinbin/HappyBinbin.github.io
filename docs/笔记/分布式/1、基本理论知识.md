## CAP 理论

- 数据一致性（Consistency）：如果系统对一个写操作返回成功，那么之后的读请求都必须读到这个新数据；如果返回失败，那么所有读操作都不能读到这个数据，对调用者而言数据具有强一致性（Strong Consistency）
- 服务可用性（Availability）：所有读写请求在一定时间内得到响应；可终止，不会一直等待。换句话说，我一定会给您返回数据，不会给你返回错误，但不保证数据最新，强调的是不出错。
- 分区容错性（Partition-Tolerance）：在网络分区的情况下，被分隔的节点仍能正常对外服务，由于分布式系统通过网络进行通信，网络是不可靠的。当任意数量的消息丢失或延迟到达时，系统仍会继续提供服务，不会挂掉。

如果选择了 CA 放弃了 P，那么当发生分区现象时，为了保证 C，系统需要禁止写入，当有写入请求时，系统会返回 error，这又和 A 冲突了，因为 A 要求返回 no error 和 no timeout。因此，分布式系统理论上不可能选择 CA 架构，只能选择 CP 或者 AP 架构



## Base 理论

Cap 理论的一种妥协，由于 Cap 只能二取其一，Base 理论降低了发生分区容错时对可用性和一致性的要求

- 基本可用：允许可用性降低（可能响应延长、可能服务降级）
- 软状态：指允许系统中的数据存在中间状态，并认为中间状态不回影响系统整体可用性
- 最终一致性：节点数据同步可以存在时延，但在一定期限后必须达成数据的一致，状态变为最终状态



## 数据一致性模型

- 强一致性：要求无论更新操作是在哪个数据副本上执行，之后所有的读操作都要能获得最新的数据。对多副本数据来说，需要使用分布式事务协议（如两阶段提交或Paxos）
- 弱一致性：在这种一致性下，用户读到某一操作对系统特定数据的更新需要一段时间，我们将这段时间成为 “不一致性窗口”
- 最终一致性：是弱一致性的一种特例，在这种一致性下系统保证用户最终能够读取到某操作对系统特定数据的更新（读取操作之前没有该数据的其他更新操作），在没有发生故障的前提下，不一致的窗口期主要受到通信延迟、系统负载、复制副本个数的影响

最终一致性模型根据其提供的不同保证可以划分为更多的模型：

- 因果一致性（Causal Consistency）：保证依赖该更新数据的对象能够读取到的数据是最新的
- 读自写一致性（Read Your Own Writes Consistency）：用户更新某个数据后读取该数据时能够获取其更新后的值
- 会话一致性（Session Consistency）：提交更新操作的用户在同一个会话里读取数据时能够保证数据是最新的
- 单调读一致性（Monotonic Read Consistency）：用户读取某个数据值，后续操作不会读取到该数据更早版本的值
- 时间轴一致性（Timeline Consistency）：要求数据的所有副本以相同的顺序执行所有的更新操作，另一种说话叫单调写一致性（Monotonic Write Consistency）

系统选择哪一种一致性模型取决于应用对一致性的需求，所选取的一致性模型还会影响到系统如何处理用户的请求以及对副本维护技术的选择等。



## WARO协议

是一种简单的副本控制协议，当 Client 请求向某副本写数据时（更新数据），只有当所有的副本都更新成功之后，这次写操作才算成功，否则视为失败。这样的话，只需要读任何一个副本上的数据即可。但是WARO带来的影响是写服务的可用性较低，因为只要有一个副本更新失败，此次写操作就视为失败了



到这里，再来看Quorum机制到底是个什么鬼？他比WARO又好在什么地方

## Quorum机制

Quorum 的定义如下：假设有 N 个副本，更新操作 wi 在 W 个副本中更新成功之后，则认为此次更新操作 wi 成功，把这次成功提交的更新操作对应的数据叫做：“成功提交的数据”。对于读操作而言，**至少需要读 R 个副本**

其中，W+R>N ，即 W 和 R 有重叠，一般，R = N - W + 1

- N = 存储数据副本的数量
- W = 更新成功所需的副本
- R = 一次数据对象读取要访问的副本的数量

听起来有些抽象，举个例子：

假设我有5个副本，更新操作成功写入了3个，另外2个副本仍是旧数据，此时在读取的时候，只要确保读取副本的数量大于2，那么肯定就会读到最新的数据。至于如何确定哪份数据是最新的，我们可以通过引入数据版本号的方式判断（Quorum 机制的使用需要配合一个获取最新成功提交的版本号的 metadata 服务，这样可以确定最新已经成功提交的版本号，然后从已经读到的数据中就可以确认最新写入的数据。）











































