# 任务切换机制

80386是一款对**多任务**操作系统提供良好支持的CPU。多道程序功能使得在某一耗时任务执行时(例如大数据的I/O)，允许其它短耗时任务并发的执行(例如接受输入的控制台命令) ，极大的提高了用户的体验



## 任务状态段

为了保证任务切换后，能够被正确的恢复，80386设计了一个专用数据结构用于保存恢复任务所必需的信息，这一特殊的数据结构被称为**任务状态段TSS**(**Task-State Segement**)，大小**至少**为104字节，其基本内容结构图如下图所示

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/pic/202204031741005.png" alt="image-20220403174145919"  />

任务状态段 TSS 中的内容，按照类型可以分为以下几个部分：

**寄存器保护区域**

位于 TSS 中间位置的寄存器保存区域，用于保存切换任务时，32位的通用寄存器(EAX、EBX等)、16位的段寄存器(CS、DS、ES等)、32位的标志寄存器EFLAGS、指令指针寄存器EIP的**快照记录**

**高特权级堆栈指针区域**

在关于数据段特权级时提到过，为了避免高特权级的程序由于栈空间不足而崩溃以及不同特权级间栈数据的交叉引用。处理器在特权级发生变化时，当前任务的堆栈也必须发生变化

具体来说就是一个任务在每个不同的特权级下，都应该拥有一个独立的堆栈。特权级一共有4个等级，同时由于特权级的限制，高特权级的任务一般无法将控制转移至低特权级的段

特权级为0的内核任务不需要额外的栈，使用自己固有的内核栈即可。特权级为1的任务需要定义一个额外的栈，用于将控制转移至特权级0时使用。依此类推，特权级为2的任务需要定义两个额外的栈，特权级为3的应用程序应该准备3个额外的堆栈以便在不同的特权级间进行切换

这在TSS中有所体现，任务切换时也必须把这些额外的栈选择子/栈顶指针记录下来，其中SS0、SS1、SS2分别是任务在特权级0、1、2时的栈段选择子，ESP0、ESP1、ESP2分别是任务在特权级0、1、2时的栈顶指针寄存器的值。至于当前任务固有的栈，则位于上述的寄存器保存区域中的SS、ESP中

不同特权级切换时的额外的栈一般是由操作系统加载任务时创建的，对应用程序是透明的

**地址映射寄存器区域**

每个任务一般都存在一个属于任务自己的段表LDT，同时如果当前CPU还开启了分页机制的话，则还需要通过一个页表来做进一步的映射，将内存的线性地址转换为最终的物理地址。所以在TSS中，存有指向当前任务LDT首地址的LDT段选择子字段，以及在分页模式下工作的CR3寄存器(PDBR Page Directory Base Register 页表基址寄存器)的值

LDT段选择子能够帮助CPU定位当前任务的段表；保存的CR3能够在开启分页机制时，指向一级页表的首地址

**任务链接字段**

386允许在任务之间进行嵌套。在中断等情况下，可以暂时打断当前任务(如应用程序)并切换至更紧急的中断处理程序(如操作系统内核内存缺页中断处理程序)

了能够在任务切换时，新任务执行完成后再切换回之前的老任务。TSS中引入了任务链接字段，用于在嵌套任务切换时，记录当前任务的前一个任务的TSS段选择子。

**IO映射位图基地址**

和LDT一样，每个任务都拥有自己的I/O映射位图，TSS中的I/O映射位图基地址用于指向当前任务的I/O映射位图，`其中的值代表着I/O许可位图相对于当前TSS内存段起始位置的偏移量。`这也是为什么TSS段最小是104字节的原因，因为在104字节的基础结构之后，还允许拓展的存放一个I/O映射位图数据

在寻找TSS时，如果发现该偏移量已经超过了TSS段描述符中的段界限，CPU不会报错，而是认为当前任务不存在I/O映射位图。这种情况下，如果任务的当前特权级CPL低于IOPL的话，将无权访问任何外设端口。

### 任务寄存器 TR

TSS和LDT一样，都被认为是一种系统内存段(**S位为0**)，对应的段描述符必须预先加载进全局描述符表GDT中。这么设计的主要目的还是为了将TSS通过特权级的机制加以保护

80386提供了LDTR寄存器用于指向当前任务的LDT段。同理，80386也提供了另一个专用的寄存器指向当前任务的TSS段，这个专用的寄存器被称为任务寄存器(**Task Resigter TR**)。TR寄存器是16位的，其中装载的是所指向的TSS段的段选择子。任务切换时，将TR中的段选择子指向新任务的TSS段即可

### TSS 段描述符

![image-20220403175403785](https://gitee.com/HappyBinbin/pcigo/raw/master/pic/202204031754846.png)

TSS作为段描述符的一种，和LDT段描述符，数据段/代码段描述符的格式差不多，最大的区别在于TYPE字段。TSS的TYPE字段为10B1，其中高2位，和最低位是固定不变的，而B位是忙(**Busy**)位的意思，B位为0时代表任务不处于忙状态，B位为1时代表任务处于忙状态

**当任务刚刚被初始化时，B位应该被操作系统设置为0。当任务处于执行状态时，或者因为中断等原因被暂时切换为挂起状态时，B位会被CPU固件设置为1**

