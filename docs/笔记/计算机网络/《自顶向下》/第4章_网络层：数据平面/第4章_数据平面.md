# 第4章 网络层：数据平面

## 4.1 网络层概述

数据平台层：从其输入链路向其输出链路转发数据报；

控制平面层：协调这些本地的每个路由器的转发动作，使得数据报沿着源和目的地主机之间的路由器最终进行端到端传送。

### 转发和路由选择

转发：是指将分组从一个输入链路接口转移到适当的数据链路接口的路由器本地动作，时间尺度很短（通常为几纳秒），因此通常用硬件来实现

路由选择：是指确定分组从源到目的地所采取的端到端路径的网络范围处理过程，时间尺度长得多（通常为几秒），因此通常用软件来实现

转发表：路由器检查到达分组首部的一个或多个字段值，进而使用这些首部值在其转发表中索引，通过这种方法来转发分组。

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210604212527780.png" alt="image-20210604212527780" style="zoom:50%;" />

### 控制平面：传统方法

​	执行路由选择协议，维护路由选择表与关联链路状态信息，为路由器计算转发表

### 控制平面：SDN方法

​	由远程控制器进行分发转发表，路由器之间不能直接进行交互，也不能主动参与计算转发表

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210530164642581.png" alt="image-20210530164642581" style="zoom: 50%;" />

### 网络服务模型

- 运输层能够指望网络层将该分组交付给目的地吗?

- 当发送多个分组时，它们会按发送顺序按序交付给接收主机的运输层吗 ？ 

- 发送两个连续分组的时间间隔与接收到这两个分组的时间间隔相同吗 ？ 

- 网络层会提供关于网络中拥塞的反馈信息吗 ？ 在发送主机与接收主机中连接运输层通道的抽象视图 （ 特性 ） 是什么 ？ 


对这些问题和其他问题的答案由网络层提供的服务模型所决定。

##### 尽力而为服务

​	不保证可靠传输、不保证有序、不保证时延、不保证带宽

##### 分组交换机

​	是指一台通用分组交换设备，它根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组

##### 链路交换机

​	基于链路层帧中的字段值做出转发决定

##### 路由器

​	基于网络层数据报中的首部字段值做出转发决定

## 4.2 路由器工作原理

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210530165032832.png" alt="image-20210530165032832" style="zoom:50%;" />

- 输入端口
    - 输入端口最左侧的方框，在路由器中执行终结入物理链路的物理层功能
    - 中间的方框，与位于入链路远端的数据链路层交互来执行数据链路层功能
    - 最右侧的方框，执行查找功能，通过查询转发表决定路由器的输出端口，到达的分组通过路由器的交换结构转发到输出端口
- 交换结构
    - 将路由器的输入端口连接到它的输岀端口。这种交换结构完全包含在路由器之中，即它是一个网络路由器中的网络
- 输出端口
    - 存储从交换结构接收的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组
- 路由选择处理器
    - 执行控制平面功能、网络管理功能

### 输入端口处理和基于目的地转发

一个更加详细的输入处理的视图

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210530212352670.png" alt="image-20210530212352670" style="zoom:50%;" />

怎样处理规模问题的例子， 假设我们的路由器具有 4 条链路，编号 0 到 3, 分组以如下方式转发到链路接口：

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210530212712371.png" alt="image-20210530212712371" style="zoom:50%;" />

前缀匹配：路由器用分组目的地址的前缀 ( prefix ) 与该表中的表项进行匹配 ； 如果存在一个匹配项，则路由器向与该匹配项相关联的链路转发分组。当有多个匹配时，该路由器使用最长前缀匹配规则 ( longest prefix matching rule) ； 即在该表中寻找最长的匹配项，并向与最长前缀匹配相关联的链路接口转发分组 。

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210530212738793.png" alt="image-20210530212738793" style="zoom:50%;" />

### 交换

交换结构位于路由器的核心部位，它可以用多种方式完成，下面介绍三种交换技术

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210530213324660.png" alt="image-20210530213324660" style="zoom:50%;" />

#### 经内存交换

​	最简单、最早的路由器是传统的计算机，在CPU的控制下进行交换。输入和输入端口就像I/O设备一样。现代许多的路由器通过内存进行交换，与早起的差别是，目的地址的查找和将分组存储转换进适当内存存储位置的操作是由输入线路卡来进行的。

#### 经总线交换

​	输入端口经一根共享总线将分组直接传送到输出端口，不需要路由选择处理器的干预。

#### 经互联网网络交换

​	克服单一、共享式总线带宽限制的方法，使用一个更复杂的互联网络。纵横交换机就是一种由2N条总线组成的互联网络，如图4-6所示。

### 输出端口处理

输出端口处理取出已经存放在输出端口内存中的分组并将其发送到输出链路上。这包括选择和取岀排队的分组进行传输，执行所需的链路层和物理层传输功能 

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210530214442035.png" alt="image-20210530214442035" style="zoom:50%;" />

### 何时出现排队

#### 输入排序

线路前部阻塞（Head Of The Line，HOL），在一个输入队列中排队的分组必须等待通过交换结构发送（即使输出端口是空闲的），因为它被位于线路前部的一个分组所阻塞。

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210530215732334.png" alt="image-20210530215732334" style="zoom:50%;" />

#### 输出排序

当没有足够的内存来缓存一个分组时，要么丢弃到达的分组（弃尾），要么删除一个或多个一排队的分组来腾出空间。

那么缓存应该需要多少呢？

​	经验：缓存数量应当等于平均往返时延乘以链路的容量（这是是基于相对少量TCP流的排队动态性分析得到的）

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210604221622847.png" alt="image-20210604221622847" style="zoom:50%;" />

### 分组调度

排队的分组如何经输出链路传出，排队算法有哪些？

#### 先进先出

FIFO，先来先服务，也就是先进先出。

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210531210503638.png" alt="image-20210531210503638" style="zoom:50%;" />

#### 优先权排队

![image-20210531210548048](https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210531210548048.png)

#### 循环和加权公平排队

将到达的分组进行分类，每个类在任何时间间隔内可能收到不同数量的服务。具体而言，每个类 i 被分配一个权 Wi。使用循环和加权公平排队（WFQ） 方式，在类 i 有分组要发送的任何时间间隔中，第 i 类将确保接收到的服务部分等于型 Wi / (∑ Wj )，式中分母中的和是计算所有有分组排队等待传输的类别得到的。在最坏的情况下，即使所有的类都有分组排队，第 i 类仍然保证分配到带宽的 Wi / (∑ Wj ) 部分。因此，对于一条传输速率为 R 的链路，第 i 类总能获得至少为 R * Wi / (∑ Wj )  的吞吐量

## 4.3 网际协议

### IPv4 数据报格式

网络层分组被称为数据报。

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210531211654468.png" alt="image-20210531211654468" style="zoom:50%;" />



- 版本：4比特，用来确定数据报的IP协议版本，以确定如何解释IP数据报的剩余部分
- 首部长度：4比特，一个IPv4可能包含一些可变数量的选项，所以要用首部长度来确定 IP 数据报中的载荷实际开始的地方。大多数的IP数据报不包含选项，所以一般的IP数据报具有20字节的首部
- 服务类型（TOS）：使不同类型的IP数据报（要求低时延、高吞吐量或可靠性的数据报）能互相区分开来。例如：将实时数据报（IP电话应用）与非实时流量（如FTP）区分开来。
- 数据报长度：16比特，IP 数据报的总长度（首部加上数据），以字节计。所以理论上 IP 数据报的理论最大长度为 65535 字节。但数据报很少超过 1500 字节的，因为该长度使得 IP 数据报能容纳最大长度以太网帧的载荷字段
- 标识、标志、片偏移：与IP分片有关（IPv6上不允许在路由器上对分组分片）
- 寿命：Time-To-Live，TTL
- 协议：该字段通常仅当一个 IP 数据报到达其最终目的地时才有用。指示了 IP 数据报的数据部分应该交给哪个特定的运输层协议。协议号与端口号的作用是类似的
- 首部校验和：帮助路由器检测收到的 IP 数据报中的比特错误
    - 为什么在运输层和网络层都进行差错检验？
        - IP 层只对 IP 首部计算了检验和，而 TCP/IP 检验和是对整个 TCP / UDP 报文段进行的
        -  TCP / UDP 与 IP 不一定都必须属于同一个协议栈，原则上，TCP 能够运行在一个不同的协议上，而 IP 能够携带不一定要传给  TCP / UDP 的数据
- 源和目的 IP 地址：源 IP 地址和目的 IP 地址
- 选项：允许 IP 首部被扩展（很少使用，IPv6中去掉了）
- 数据（有效载荷）：IP 数据报中的数据字段包含要交付给目的地的运输层报文段。也可以承载其他类型的数据，如 ICMP 报文

### IPv4 数据报分片

​	并不是所有链路层协议都能承载相同长度的网络层分组，像以太网帧能承载不超过 1500 字节的数据，而某些广域网链路的帧可承载不超过 576 字节的数据。链路层协议的MTU严格限制着 IP 数据报的长度，发送方和接收方路径上的每段链路可能使用不同的链路层协议，且每种协议可能具有不同的MTU

##### 最大传输单元

​	一个链路层帧能承载的最大数据量叫做最大传输单元（Maximum Transmission Unit，MTU）

#### 分片具体过程

假定你从某条链路收到一个 IP 数据报，通过检查转发表确定出链路，并且该条出链路的 MTU 比该 IP 数据报的长度要小。此时你会感到慌乱，如何将这个过大的 IP 分组挤进链路层帧的有效载荷字段呢 ？ 解决该问题的方法是将 IP 数据报中的数据分片成两个或更多个较小的 IP 数据报，用单独的链路层帧封装这些较小的 IP 数据报，然后通过输出链路发送这些帧。每个这些较小的数据报都称为片( fragment )

IPv4 的设计者将标识 、 标志和片偏移字段放在 IP 数据报首部中。当生成一个数据报时，发送主机在为该数据报设置源和目的地址的同时贴上标识号。发送主机通常将它发送的每个数据报的标识号加 1。当某路由器需要对一个数据报分片时，形成的每个数据报 （ 即片 ） 具有初始数据报的源地址 、 目的地址与标识号。当目的地从同一发送主机收到一系列数据报时，它能够检查数据报的标识号以确定哪些数据报实际上是同一较大数据报的片。由于 IP 是一种不可靠的服务，一个或多个片可能永远到达不了目的地。因为这种原因，为了让目的主机绝对地相信它已收到了初始数据报的最后一个片，最后一个片的标志比特被设为 0, 而所有其他片的标志比特被设为 1。另外，为了让目的主机确定是否丢失了一个片 （ 且能按正确的顺序重新组装片 ），使用偏移字段指定该片应放在初始 IP 数据报的哪个位置 

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210531220223362.png" alt="image-20210531220223362" style="zoom:50%;" />

### IPv4 编址

这里出现了几个子网呢 ？

​	3 个子网 223.1.1.0/24 、 223. 1. 2. 0/24 和 223. 1.3.0/24 。但注意到在本例中还有其他 3 个子网 ： 一个子网是 223.1.9. 0/24, 用于连接路由器 R1 与 R2 的接口 ； 另外一个子网是 223.1.8.0/24, 用于连接路由器 R2 与 R3 的接口 ； 第三个子网是 223. 1.7.0/24, 用于连接路由器 R3 与 R1的接口。对于一个路由器和主机的通用互联系统，我们能够使用下列有效方法定义系统中的子网:

> ​	为了确定子网，分开主机和路由器的每个接口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点。这些隔离的网络种的每一个都叫做一个子网

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210601194816359.png" alt="image-20210601194816359" style="zoom:50%;" />

##### 无类别域间路由选择

因特网的地址分配策略被称为无类别域间路由选择。IP 地址的形式为 a.b.c.d/x，其中 x 指示了地址的第一部分中的比特数。地址 x 的最高比特构成了 IP 地址的网络部分，也被称为前缀。剩余的 32-x 比特是用于区分组织内部设备的，其中的所有设备具有相同的网络前缀。

##### 地址聚合

​	使用单个网络前缀通告多个网络的能力通常称为地址聚合，也叫路由聚合；

##### 分类编址

​	IP地址的网络部分被限制为长度为8、16、24比特，这是一种分类编址的编址方案。具有 8、16 和 24 比特子网地址
的子网分别被称为 A、B 和 C 类网络。一个C 类 （ /24 ） 子网仅能容纳多达 2^8 -2 =254 （ 2^8 = 256, 其中的两个地址预留用于特殊用途 ） 台主机，这对于许多组织来说太小了。然而一个 B 类 （ /16 ） 子网可支持多达 65 534 台主机，又太大了。

##### 广播地址

IP 广播地址为 255.255.255.255，一台主机发出目的地之为该地址的数据报时，报文会交付给同一个网络中的所有主机。

#### 获取一块地址

​	由ICANN来负责分配 IP 地址，ISP从其得到一块地址，网络管理员再与他的 ISP 联系，得到一块 IP 地址。

 例如，该 1SP 也许自己已被分配了地址块 200. 23. 16. 0/20 。该 ISP 可以依次将该地址块分成 8 个长度相等的连续地址块，为本 ISP 支持的最多达 8 个组织中的一个分配这些地址块中的一块，如下所示

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210601201711728.png" style="zoom:50%;" />

#### 获得主机地址：

​	某组织获得了一块地址，就可以为本组织内的主机与路由器接口逐个分配 IP 地址。这些工作可以由系统管路员来配置，但现在更多的是使用动态主机配置协议（DHCP）来完成。

##### DHCP

​	动态主机配置协议，允许主机自动获取一个 IP 地址，允许一台主机得知其他信息，例如它的子网掩码、第一跳路由器地址（默认网关）、本地 DNS 服务器地址等。由于DHCP具有将主机连接进一个网络的网络相关方面的自动能力，所有它又被称为即插即用协议或零配置协议。

因为有许多用户来来往往，并且在有限的时间内需要地址，DHCP的即插即用能力的价值是显然的。

DHCP 是一个客户 - 服务器协议，是一个四个步骤的过程， 如图 4 -24 中所示。在这幅图中，yiddr （ 表示 “ 你的因特网地址 ” 之意 ） 指示分配给该新到达客户的地址 

##### :star:DHCP 服务的连接步骤

- DHCP 服务器发现
    -  一台新到达的主机的首要任务是发现一个要与其交互的 DHCP服务器。这可通过使用 DHCP 发现报文 （ DHCP discover message ） 来完成，客户在UDP 分组中向端口 67 发送该发现报文。该 UDP 分组封装在一个 IP 数据报中。但是这个数据报应发给谁呢？主机甚至不知道它所连接网络的 IP 地址，更不用说用于该网络的 DHCP 服务器地址了。在这种情况下，DHCP 客户生成包含 DHCP 发现报文的 IP 数据报，其中使用广播目的地址 255.255.255.255 并且使用 “ 本主机 ” 源 IP 地址 0.0.0.0。DHCP 客户将该 IP 数据报传递给链路层，链路层然后将该帧广播到所有与该子网连接的节点。
- DHCP 服务器提供
    -  DHCP 服务器收到一个 DHCP 发现报文时，用 DHCP 提供报文 ( DHCP offer message ) 向客户做出响应，该报文向该子网的所有节点广播，仍因为在子网中可能存在几个 DHCP 服务器，该客户也许会发现它处于能在几个提供者之间进行选择的优越位置。每台服务器提供的报文包含有收到的发现报文的事务 ID 、 向客户推荐的 IP 地址 、 网络掩码以及 IP 地址租用期 ( ad-dress lease time ) , 即 IP 地址有效的时间量。服务器租用期通常设置为几小时或几天然使用 IP 广播地址 255. 255. 255. 255
- DHCP 请求
    - 新到达的客户从一个或多个服务器提供中选择一个，并向选中的服务器提供用 DHCP 请求报文 ( DHCP request message ) 进行响应，回显配置的参数
- DHCP ACK
    - 服务器用 DHCP ACK 报文 (DHCP ACK message) 对 DHCP 请求报文进行响应，证实所要求的参数 

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210601203551917.png" alt="image-20210601203551917" style="zoom: 50%;" />

### 网络地址转换

​	随着小型办公室、家庭办公室（Small Office，Home Office，SOHO）子网的大量出现，ISP分配一组地址以供该SOHO的所有 IP 设备使用变得很笨。如果 ISP 已经为 SOHO 网络的当前地址分配过一块连续的地址，而子网变大了，地址不够用了怎么办？网络地址转换的方法应运而生

Network Address Translation，NAT，网络地址转换。

具有专用地址的地域是指其地址仅对该网络中的设备有意义的网络，也就是只有在特定的网络中，它们才有意义。

如果从广域网到达 NAT 路由器的所有数据报都有相同的目的 IP 地址 （ 特别是对 NAT 路由器广域网一侧的接口 ），那么该路由器怎样知道它应将某个分组转发给哪个内部主机呢 ？ 技巧就是使用 NAT 路由器上的一张 NAT 转换表 （ NAT translation table ） , 并且在表项中包含了端口号及其 IP 地址 。

NAT的具体例子：

​	假设一个用户坐在家庭网络主机 10.0.0.1 后，请求 IP 地址为12.119.40.186 的某台 Web 服务器 （ 端口 80 ） 上的一个 Web 页面。主机 10. 0. 0. 1 为其指派了 （ 任意 ） 源端口号 3345 并将该数据报发送到 LAN 中。NAT 路由器收到该数据报，为该数据报生成一个新的源端口号 5001, 将源 IP 替代为其广域网一侧接口的 IP 地址 138.76.29.7, 且将源端口 3345 更换为新端口 5001。当生成一个新的源端口号时，NAT 路由器可选择任意一个当前未在 NAT 转换表中的源端口号。（ 注意到因为端口号字段为 16 比特长，NAT 协议可支持超过 60 000 个并行使用路由器广域网一侧单个 IP 地址的连接！）路由器中的 NAT 也在它的 NAT 转换表中增加一表项。Web 服务器并不知道刚到达的包含 HTTP 请求的数据报已被 NAT 路由器进行了改装，它会发回一个响应报文，其目的地址是 NAT 路由器的 IP 地址，其目的端口是 5001。当该报文到达 NAT 路由器时，路由器使用目的 IP 地址与目的端口号从 NAT 转换表中检索出家庭网络浏览器使用的适当 IP 地址（ 10. 0. 0.1 ） 和目的端口号 （ 3345 ）。于是，路由器重写该数据报的目的 1P 地址与目的端口号，并向家庭网络转发该数据报 

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210601205810734.png" alt="image-20210601205810734" style="zoom:50%;" />

### IPv6

​	由于新的子网和 IP 节点增长速率过快，32 比特的 IP 地址空间即将用尽，IPv6 应运而生。

#### IPv6 数据包格式

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210601210530730.png" alt="image-20210601210530730" style="zoom: 67%;" />

- 扩大的地址容量：IP 地址长度由 32 位 增加到 128 位。引入了一种任播地址的新型地址，该地址可以使数据报交付给一组主机中的任意一个
- 简化高效的 40 字节首部
- 流标签：20 比特，用于”给属于特殊流的分组加上标签，这些特殊流是发送方要求进行特殊处理的流，例如非默认服务质量或需要实时服务的流“，就是能对一条流中的某些数据报给出优先权。例如 IP 语音的数据包给出更高的优先权，以优于来自其他应用（如 SMTP ） 的数据报。
- 版本：4 比特，值为56，用于标记 IP 版本号
- 流量类型：8比特，与 IPv4 中的 TOS 字段含义相似
- 有效载荷长度：该16比特值作为一个无符号整数，给出了 IPv6 数据报中跟在定长 40 字节数据报首部后面的字节数量。
- 下一个首部：表示数据报中内容（数据字段）需要交付给哪个协议
- 跳限制：转发数据报的每台路由器对该字段的内容减1，为0时丢弃数据报
- 源地址和目的地址
- 数据：有效载荷部分
- 分片/重新组装：IPv6 不允许在中间路由器中进行分片与重新组，这种操作只能在源与目的地执行。如果路由器收到的 IPv6 数据报太大而不能转发到处链路上的话，则发送回一个 “分组太大”的 ICMP差错报文，发送方就能使用较小长度的 IP 数据报重发数据。
- 首部校验和：设计者认为，已经在链路层和运输层进行了校验，再在网络层校验则意义不大，所以将其去除了。
- 选项：该字段不再是标准 IP 首部的一部分，它可能会出现在 “下一个首部”的位置上

#### 从 IPv4 到 IPv6 的迁移

IPv4 如何与 IPv6 进行兼容呢？

##### 隧道

 假定两个 IPv6 节点 （ 如图 4.27 中的 B 和 E ） 要使用 IPv6 数据报进行交互,但它们是经由中间 IPv4 路由器互联的 。我们将两台 IPv6 路由器之间的中间 IPv4 路由器的集合称为一个隧道 （ tunnel )

借助于隧道，在隧道发送端的 IPv6 节点（ 如 B ） 可将整个 IPv6 数据报放到一个 IPv4 数据报的数据 （ 有效载荷 ） 字段中 。于是，该 IPv4 数据报的地址设为指向隧道接收端的 IPv6 节点 （ 在此例中为 E ） , 再发送给隧道中的第一个节点 （ 在此例中为 C ） 。隧道中的中间 IPv4 路由器在它们之间为该数据报提供路由，就像对待其他数据报一样，完全不知道该 IPv4 数据报自身就含有一个完整的IPv6 数据报 。隧道接收端的 IPv6 节点最终收到该 IPv4 数据报 （ 它是该 IPv4 数据报的目的地 ），并确定该 IPv4 数据报含有一个 IPv6 数据报 （ 通过观察在 IPv4 数据报中的协议号字段是 41 [RFC 4213], 指示该 IPv4 有效载荷是 IPv6 数据报 ），从中取出 IPv6 数据报,然后再为该IPv6 数据报提供路由,就好像它是从一个直接相连的 IPv6 邻居那里接收到该 IPv6 数据报一样 

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210601215206985.png" alt="image-20210601215206985" style="zoom:50%;" />

## 4.4 通用转发和SDN

​	第二层交换机和第三层路由器等中间盒的剧增 ， 而且每种都有自己特殊的硬件 、 软件和管理界面 ， 无疑给许多网络操作员带来了十分头疼的大麻烦 。 然而 ， 近期软件定义网络的进展已经预示并且正在提出一种统一的方法 ， 以一种现代 、 简洁和综合方式 ， 提供多种网络层功能以及某些链路层功能 

基于目的地转发的特征总结为两个步骤 ：

- 查找目的 IP 地址 （“ 匹配 ”）
- 将分组发送到有特定输出端口的交换结构 （“ 动作 ”）

现在考虑一种更有意义的通用 “ 匹配加动作 ” 范式 ， 其中能够对协议栈的多个首部字段进行 “ 匹配 ” ， 这些首部字段是与不同层次的不同协议相关联的 。 “

动作 ” 能够包括 ： 将分组转发到一个或多个输出端口 （ 就像在基于目的地转发中一样 ） ， 跨越多个通向服务的离开接口进行负载均衡分组 （ 就像在负载均衡中一样 ） ， 重写首部值 （ 就像在 NAT 中一样 ） ， 有意识地阻挡 / 丢弃某个分组 （ 就像在防火墙中一样 ） ， 为进一步处理和动作而向某个特定的服务器发送一个分组 （ 就像在 DPI — 样 ） ， 等等

因为能够使用网络层和 / 或链路层源和目的地址做出转发决定 所以显示在图 4-28 中的转发设备更为准确地描述为 “ 分组交换机 ”，每台分组交换机中的一张匹配加动作表 ， 该表由远程控制器计算 、安装和更新 。

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210601221734960.png" alt="image-20210601221734960" style="zoom: 50%;" />

##### 匹配加动作转发表

匹配加动作转发表在 OpenFlow 中称为流表，它的每个项包括：

- 首部字段值的集合， 入分组将与之匹配 。 与基于目的地转发的情况一样 ， 基于硬件匹配在 TCAM 内存中执行得最为迅速 （ TCAM 内存中可能有上百万条地址表项 ）。 匹配不上流表项的分组将被丢弃或发送到远程控制器做更多处理 。 在实践中 ， 为了性能或成本原因 ， 一个流表可以由多个流表实现，但我们这里只关注单一流表的抽象
-  计数器集合 （ 当分组与流表项匹配时更新计数器 ） 。 这些计数器可以包括已经与该表项匹配的分组数量 ， 以及自从该表项上次更新以来的时间 。
-  当分组匹配流表项时所采取的动作集合 。 这些动作可能将分组转发到给定的输出端口 ， 丢弃该分组 、 复制该分组和将它们发送到多个输岀端口 ， 和 / 或重写所选的首部字段 

#### 匹配

OpenFlow 的匹配抽象允许对来自三个层次的协议首部所选择的字段进行匹配

<img src="https://gitee.com/HappyBinbin/pcigo/raw/master/image-20210602113107880.png" alt="image-20210602113107880" style="zoom:50%;" />

#### 动作

如图 4-28 中所见 ， 每个流表项都有零个或多个动作列表 ， 这些动作决定了应用于与流表项匹配的分组的处理 。 如果有多个动作 ， 它们以在表中规定的次序执行

其中最为重要的动作可能是 ：

- 转发 。 一个入分组可以转发到一个特定的物理输岀端口 ， 广播到所有端口 （ 分组到达的端口除外 ） ， 或通过所选的端口集合进行多播 。 该分组可能被封装并发送到用于该设备的远程控制器 。 该控制器则可能 （ 或可能不 ） 对该分组采取某些动作,包括安装新的流表项 ， 以及可能将该分组返回给该设备以在更新的流表规则集合下进行转发 。
- 丢弃 。 没有动作的流表项表明某个匹配的分组应当被丢弃 。
- 修改字段 。 在分组被转发到所选的输出端口之前 ， 分组首部 10 个字段 （ 图 4-29 中显示的除 IP 协议字段外的所有第二 、 三 、 四层的字段 ） 中的值可以重写

## 4.5 小结

​	本节，我们讨论了网络层数据平面的功能，即每台路由器：决定到达路由器的输入链路之一的分组如何转发到该路由器的输出链路之一

- 输入/输入端口功能
- 基于目的地的转发
- 路由器的内部交换机制
- 分组排队管理
- 传统的 IP 转发
- 通用转发
- IPv4 和 IPv6

















































