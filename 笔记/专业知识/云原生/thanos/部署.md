web 查看各个组件
```
http://10.134.89.110:10905
http://10.134.89.110:10904
http://10.134.89.110:9091
http://10.134.89.110:9090
http://10.134.89.110:9000
```

thanos sidecar 启动

``` bash
/Users/happychan/go/bin/thanos sidecar --tsdb.path "/Users/happychan/Documents/sourcecode/prometheus/data" --prometheus.url "http://localhost:9090" --objstore.config-file  "bucket.yml"
```

bucket.yml minio S3 配置

``` yaml
type: S3
config:
  bucket: thanos
  endpoint: 127.0.0.1:9000
  access_key: minioadmin
  secret_key: minioadmin
  insecure: true
  signature_version2: false
  http_config:
    idle_conn_timeout: 5m
    response_header_timeout: 1m
    insecure_skip_verify: true
```

主机网络部署thanos组件

``` bash

# 创建目录
mkdir thanos-local && cd thanos-local
mkdir -p data/{prometheus,thanos/{sidecar,store-gateway,compact}}

# 设置各个目录的权限
# 方式一：直接开放写权限（推荐用于本地测试）
chmod -R 777 ./data/thanos/
# 方式二：使用 Bitnami 推荐的用户 UID 1001
sudo chown -R 1001:1001 ./data/thanos/

# 编写docker-compose
# 暴露对应本机端口

```


docker-compose.yaml
``` yaml
version: '3.8'

services:
  minio:
    image: mirrors.sangfor.com/bitnami/minio
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    network_mode: host
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./data/minio:/data
    restart: unless-stopped

  prometheus:
    image: mirrors.sangfor.com/bitnami/prometheus
    network_mode: host
	 command:
	  - '--config.file=/etc/prometheus.yml'
	  - '--storage.tsdb.path=/prometheus'
	  - '--storage.tsdb.min-block-duration=2h'
	  - '--storage.tsdb.max-block-duration=2h'
	  - '--web.enable-lifecycle'
    volumes:
      - ./prometheus.yml:/etc/prometheus.yml:ro
      - ./data/prometheus:/prometheus
    restart: unless-stopped

  thanos-sidecar:
    image: mirrors.sangfor.com/bitnami/thanos
    network_mode: host
    command: >
      sidecar
      --tsdb.path=/prometheus
      --prometheus.url=http://127.0.0.1:9090
      --grpc-address=0.0.0.0:10901
      --http-address=0.0.0.0:10902
      --objstore.config-file=/etc/thanos/objstore.yaml
    volumes:
      - ./thanos-objstore.yaml:/etc/thanos/objstore.yaml:ro
      - ./data/prometheus:/prometheus
    restart: unless-stopped

  thanos-store-gateway:
    image: mirrors.sangfor.com/bitnami/thanos
    network_mode: host
    command: >
      store
      --http-address=0.0.0.0:10910
      --grpc-address=0.0.0.0:10911
      --objstore.config-file=/etc/thanos/objstore.yaml
      --data-dir=/var/thanos/store-gateway
    volumes:
      - ./thanos-objstore.yaml:/etc/thanos/objstore.yaml:ro
      - ./data/thanos/store-gateway:/var/thanos/store-gateway
    restart: unless-stopped

  thanos-query:
    image: mirrors.sangfor.com/bitnami/thanos
    network_mode: host
    command: >
      query
      --http-address=0.0.0.0:9091
      --query.replica-label=replica
      --store.sd-files=/etc/thanos/store-endpoints.yaml  # 使用文件模式
    ports:
      - "9091:9091"
	volumes:
	  - ./store-endpoints.yaml:/etc/thanos/store-endpoints.yaml:ro
    restart: unless-stopped

  thanos-compactor:
    image: mirrors.sangfor.com/bitnami/thanos
    network_mode: host
    command: >
      compact
      --http-address=0.0.0.0:10905
      --objstore.config-file=/etc/thanos/objstore.yaml
      --data-dir=/var/thanos/compact
      --wait
      --retention.resolution-raw=20d        # 原始数据保留 20 天
      --retention.resolution-5m=30d        # 5 分钟降采样数据保留 30 天
      --retention.resolution-1h=180d       # 1 小时降采样数据保留 180 天
    volumes:
      - ./thanos-objstore.yaml:/etc/thanos/objstore.yaml:ro
      - ./data/thanos/compact:/var/thanos/compact
    restart: unless-stopped
```

thanos-objstore.yaml

``` yaml
# thanos-objstore.yaml
type: S3
config:
  bucket: "thanos"
  endpoint: "127.0.0.1:9000"
  access_key: "minioadmin"
  secret_key: "minioadmin"
  insecure: true

```

store-endpoints.yaml

``` yaml
- targets:
    - "127.0.0.1:10910"
  labels:
    cluster: "happy"
- targets:
    - "127.0.0.1:10903"
  labels:
    cluster: "happy"

```

prometheus.yaml

``` yaml
# prometheus.yml
global:
  scrape_interval:     1s
  evaluation_interval: 1s
  # 配置thanos compator需要配置全局标签，避免重复
  external_labels:
    replica: "0"
    cluster: "happy"


# 添加 'storage' 配置块（注意：这不是在 scrape_configs 下面）
storage:
  tsdb:
    # 关键：禁用 Prometheus 自身的压缩
    min-block-duration: 2h
    max-block-duration: 2h

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

## 检视

查看 minio 中的数据块目前的情况


``` bash
docker exec -it 11872461cf54   thanos tools bucket inspect   --objstore.config-file=/etc/thanos/objstore.yaml

ts=2025-08-21T07:23:18.871098477Z caller=factory.go:54 level=info msg="loading bucket configuration"
ts=2025-08-21T07:23:18.886863276Z caller=fetcher.go:628 level=info component=block.BaseFetcher msg="successfully synchronized block metadata" duration=14.717019ms duration_ms=14 cached=5 returned=5 partial=0
|            ULID            |         FROM         |        UNTIL         |    RANGE     |  UNTIL-DOWN   | #SERIES |  #SAMPLES  | #CHUNKS | COMP-LEVEL | COMP-FAILED |         LABELS          | RESOLUTION | SOURCE  |
|----------------------------|----------------------|----------------------|--------------|---------------|---------|------------|---------|------------|-------------|-------------------------|------------|---------|
| 01K352P5SCF57STC6H75R1WCHF | 2025-08-20T07:53:38Z | 2025-08-20T08:00:00Z | 6m21.766s    | 39h53m38.234s | 10      | 260        | 10      | 1          | false       | cluster=happy,replica=0 | 0s         | sidecar |
| 01K352P5V080XC6ZJ1VENG4RYY | 2025-08-20T08:00:08Z | 2025-08-20T10:00:00Z | 1h59m51.766s | 38h0m8.234s   | 2,610   | 833,689    | 7,647   | 1          | false       | cluster=happy,replica=0 | 0s         | sidecar |
| 01K35CZRT7XV0BMSNW5EW259ZJ | 2025-08-21T01:07:58Z | 2025-08-21T02:00:00Z | 52m1.622s    | 39h7m58.378s  | 2,645   | 1,817,432  | 17,986  | 1          | false       | cluster=happy,replica=0 | 0s         | sidecar |
| 01K35FZ1BT8DE2RN31HZ7ATTR6 | 2025-08-21T02:00:00Z | 2025-08-21T04:00:00Z | 1h59m59.824s | 38h0m0.176s   | 2,669   | 18,544,450 | 158,196 | 1          | false       | cluster=happy,replica=0 | 0s         | sidecar |
| 01K35PTS061H7EEAVQ0YQPAEKX | 2025-08-21T04:00:00Z | 2025-08-21T06:00:00Z | 1h59m59.874s | 38h0m0.126s   | 2,599   | 18,712,800 | 158,539 | 1          | false       | cluster=happy,replica=0 | 0s         | sidecar |
ts=2025-08-21T07:23:18.889393904Z caller=main.go:174 level=info msg=exiting

```
